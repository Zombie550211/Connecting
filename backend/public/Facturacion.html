<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Facturación</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { margin: 0; font-family: 'Inter', Arial, sans-serif; background: #f5f7fa; color: #1e293b; }
    .sidebar { position: fixed; left: 0; top: 0; width: 200px; height: 100vh; background: #f4f7fb; display: flex; flex-direction: column; padding: 0 0 20px 0; z-index: 10; }
    .sidebar .logo { font-weight: bold; color: #22b3ec; font-size: 1.3rem; text-align: center; padding: 24px 0 16px 0; letter-spacing: 1px; }
    .sidebar nav ul { list-style: none; padding: 0 0 0 0; margin: 0; }
    .sidebar nav ul li { margin: 0; padding: 0; }
    .sidebar nav ul li a { display: block; padding: 12px 22px; color: #1e293b; text-decoration: none; font-weight: 600; border-left: 4px solid transparent; transition: background 0.1s, border-left 0.15s; }
    .sidebar nav ul li a.active, .sidebar nav ul li a:hover { background: #e3e8ee; border-left: 4px solid #22b3ec; color: #0073a8; }
    .main-content { margin-left: 200px; padding: 30px 40px; min-height: 100vh; background: #f5f7fa; }
    .top-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; background: #fff; padding: 16px 24px 12px 18px; border-radius: 13px; box-shadow: 0 2px 10px #0001; }
    .top-bar label { font-weight: 600; font-size: 1.07em; }
    .top-bar select { padding: 4px 14px; font-size: 1em; border-radius: 6px; border: 1.2px solid #e3e8ee; background: #fafcfd; color: #1e293b; font-family: inherit; font-weight: 500; box-shadow: 0 1px 3px 0 #28b5e803; }
    h1 { text-align: center; margin: 8px 0 20px 0; font-size: 2.0em; font-weight: 700; color: #21304c; letter-spacing: .3px; }
    .tabla-facturacion-container { background: #fff; border-radius: 15px; box-shadow: 0 4px 24px 0 rgba(30,41,59,0.09); padding: 16px 0 0 0; margin-bottom: 24px; }
    #tabla-facturacion { border-collapse: separate; border-spacing: 0; width: 100%; background: #fff; color: #1e293b; font-size: 1em; table-layout: fixed; border: none; }
    #tabla-facturacion th, #tabla-facturacion td { border: 1px solid #e3e8ee; text-align: center; min-width: 80px; max-width: 150px; height: 32px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0; font-size: .99em; font-weight: 400; background: #fff; }
    #tabla-facturacion th { background: #edf3fa; font-weight: 700; font-size: 0.97em; height: 36px; color: #111; }
    #tabla-facturacion td { background: #fff; }
    #tabla-facturacion tr:nth-child(even) td { background: #f1f5fa; }
    #tabla-facturacion tr:hover td { background: #d9f7fb; }
    #tabla-facturacion th:nth-child(2), #tabla-facturacion td:nth-child(2),
    #tabla-facturacion th:nth-child(5), #tabla-facturacion td:nth-child(5),
    #tabla-facturacion th:nth-child(8), #tabla-facturacion td:nth-child(8) { border-left: 2px solid #000; }
    #tabla-facturacion th:nth-child(4), #tabla-facturacion td:nth-child(4),
    #tabla-facturacion th:nth-child(7), #tabla-facturacion td:nth-child(7),
    #tabla-facturacion th:nth-child(10), #tabla-facturacion td:nth-child(10) { border-right: 2px solid #000; }
    #expandir-tabla { float: right; margin: 10px 30px 10px 0; background: #22b3ec; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px #22b3ec22; transition: background 0.15s; }
    #expandir-tabla:hover { background: #18a0d6; }
    .tabla-paginacion { width: 100%; display: flex; justify-content: flex-end; gap: 10px; margin: 10px 40px 0 0; }
    .tabla-paginacion button { padding: 5px 17px; border-radius: 10px; background: #28b5e8; color: #fff; border: none; font-weight: 600; font-size: 1.07em; cursor: pointer; box-shadow: 0 1px 4px #28b5e813; transition: background 0.18s; }
    .tabla-paginacion button:disabled { background: #b7e8f5; color: #eee; cursor: default; }
    .gastos-mes-container { background: #fff; border-radius: 15px; box-shadow: 0 4px 24px 0 rgba(30,41,59,0.09); margin-top: 28px; padding: 18px 24px 32px 24px; min-height: 160px; position: relative; }
    .gastos-mes-container h2 { margin: 0 0 16px 0; font-size: 1.09em; font-weight: bold; color: #1e293b; letter-spacing: .2px; }
    #gastos-mes { min-height: 72px; }
    #guardar-gastos { position: absolute; bottom: 18px; right: 28px; background: #6dc3e1; color: #fff; border: none; border-radius: 8px; padding: 8px 22px; font-size: 1em; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px #22b3ec22; transition: background 0.15s; }
    #guardar-gastos:hover { background: #22b3ec; }
    @media (max-width:900px) { .main-content { margin-left: 0; padding: 10px 5px; } .sidebar { display:none; } }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">Connecting</div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="lead.html">Lead</a></li>
        <li><a href="costumer.html">Costumer</a></li>
        <li><a href="Facturacion.html" class="active">Facturación</a></li>
        <li><a href="logout">Cerrar sesión</a></li>
      </ul>
    </nav>
  </div>
  <div class="main-content">
    <div class="top-bar">
      <label for="mes">Mes:</label>
      <select id="mes"></select>
      <label for="ano">Año:</label>
      <select id="ano"></select>
    </div>
    <h1>Facturación</h1>
    <div class="tabla-facturacion-container">
      <table id="tabla-facturacion">
        <thead>
          <tr>
            <th>FECHA</th>
            <th>ALEXIS</th>
            <th>VENTAS POR DIA</th>
            <th>VALOR DE VENTA</th>
            <th>CUENTA ALTERNA</th>
            <th>VENTAS POR DIA</th>
            <th>VALOR DE VENTA</th>
            <th>LINEAS</th>
            <th>VENTAS POR DIA</th>
            <th>VALOR DE VENTA</th>
            <th>TOTAL DEL DIA</th>
            <th>TOTAL VENTAS</th>
            <th>VALOR VENTA</th>
            <th>PUNTOS</th>
            <th>CPA PUNTOS</th>
          </tr>
        </thead>
        <tbody id="facturacion-body"></tbody>
        <tr id="fila-totales">
          <td>TOTALES</td>
          <td colspan="14"></td>
        </tr>
      </table>
      <button id="expandir-tabla">Expandir tabla</button>
    </div>
    <div class="tabla-paginacion">
      <button onclick="subirTabla()" id="btnUp">&#8593; Arriba</button>
      <button onclick="bajarTabla()" id="btnDown">Abajo &#8595;</button>
    </div>
    <div class="gastos-mes-container">
      <h2>Total de gastos por mes</h2>
      <div id="gastos-mes"></div>
      <button id="guardar-gastos">Guardar</button>
    </div>
  </div>
  <script>
    // ------ Selects de Mes y Año ------
    const meses = [
      "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];
    const mesSelect = document.getElementById('mes');
    const anoSelect = document.getElementById('ano');
    const hoy = new Date();
    meses.forEach((m, idx) => {
      const opt = document.createElement('option');
      opt.value = String(idx + 1).padStart(2, '0');
      opt.textContent = m;
      if (idx === hoy.getMonth()) opt.selected = true;
      mesSelect.appendChild(opt);
    });
    for (let y = hoy.getFullYear(); y >= 2022; y--) {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      if (y === hoy.getFullYear()) opt.selected = true;
      anoSelect.appendChild(opt);
    }

    // ------ Variables de paginación ------
    let bloque = 0;
    let datosFacturacion = [];
    const filasPorBloque = 16;

    // Normaliza cualquier string de fecha a formato "DD/MM/YYYY"
    function normalizaFecha(fechaStr) {
      if (!fechaStr) return "";
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(fechaStr)) return fechaStr; // Ya está bien
      if (/^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) { // "YYYY-MM-DD"
        const [yyyy, mm, dd] = fechaStr.split('-');
        return `${dd.padStart(2, '0')}/${mm.padStart(2, '0')}/${yyyy}`;
      }
      // "D/M/YYYY" o "DD/M/YYYY" etc.
      const parts = fechaStr.split(/[\/\-]/);
      if (parts.length === 3) {
        let [a, b, c] = parts;
        if (a.length === 4) { // YYYY/M/D
          return `${c.padStart(2, '0')}/${b.padStart(2, '0')}/${a}`;
        } else { // D/M/YYYY
          return `${a.padStart(2, '0')}/${b.padStart(2, '0')}/${c}`;
        }
      }
      return fechaStr;
    }

    // ------ Render Tabla Principal ------
    async function cargarFacturacion() {
      const mes = mesSelect.value;
      const ano = anoSelect.value;
      bloque = 0;
      await fetchDatos(mes, ano);
      renderTabla();
    }

    async function fetchDatos(mes, ano) {
      try {
        const res = await fetch(`/api/facturacion/${ano}/${mes}`);
        const json = await res.json();
        if (json.ok && Array.isArray(json.data)) {
          datosFacturacion = json.data.map(row => {
            row.fecha = normalizaFecha(row.fecha);
            return row;
          });
        } else {
          datosFacturacion = [];
        }
      } catch {
        datosFacturacion = [];
      }
    }

    function diasEnMes(ano, mes) {
      return new Date(Number(ano), Number(mes), 0).getDate();
    }

    function renderTabla() {
      const body = document.getElementById('facturacion-body');
      body.innerHTML = "";
      const mes = mesSelect.value;
      const ano = anoSelect.value;
      const dias = diasEnMes(ano, mes);
      const start = bloque * filasPorBloque;
      const end = Math.min(start + filasPorBloque, dias);

      for (let i = start; i < end; i++) {
        const fecha = String(i+1).padStart(2, '0') + '/' + mes + '/' + ano;
        const fila = datosFacturacion.find(f => normalizaFecha(f.fecha) === fecha);
        const campos = fila && Array.isArray(fila.campos) ? fila.campos : Array(14).fill('');
        const tr = document.createElement('tr');
        const tdFecha = document.createElement('td');
        tdFecha.textContent = fecha;
        tr.appendChild(tdFecha);
        for (let c = 0; c < 14; c++) {
          const td = document.createElement('td');
          td.textContent = campos[c] ?? '';
          tr.appendChild(td);
        }
        body.appendChild(tr);
      }
      renderTotales();
    }

    function renderTotales() {
      const totales = Array(14).fill(0);
      datosFacturacion.forEach(fila => {
        if (Array.isArray(fila.campos)) {
          for (let c = 0; c < 14; c++) {
            totales[c] += Number(fila.campos[c]) || 0;
          }
        }
      });
      const filaTotales = document.getElementById('fila-totales');
      filaTotales.innerHTML = '<td>TOTALES</td>' +
        totales.map(t => `<td>${t !== 0 ? t : ''}</td>`).join('');
    }

    // ------ Paginación ------
    function bajarTabla() {
      const mes = mesSelect.value;
      const ano = anoSelect.value;
      const dias = diasEnMes(ano, mes);
      if ((bloque + 1) * filasPorBloque < dias) {
        bloque++;
        renderTabla();
      }
    }
    function subirTabla() {
      if (bloque > 0) {
        bloque--;
        renderTabla();
      }
    }

    // ------ Event Listeners ------
    mesSelect.addEventListener('change', cargarFacturacion);
    anoSelect.addEventListener('change', cargarFacturacion);

    document.getElementById('guardar-gastos').onclick = () => {
      alert('Funcionalidad de guardar gastos próximamente...');
    };

    // ------ Inicial ------
    window.addEventListener('DOMContentLoaded', cargarFacturacion);

    document.getElementById('expandir-tabla').onclick = () => {
      alert('Función de expandir tabla no implementada en este demo.');
    };
  </script>
</body>
</html>