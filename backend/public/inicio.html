<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inicio - Connecting CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f4f7fc;
      --sidebar-bg: #ffffff;
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --panel-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --panel-radius: 1rem;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .layout { display: flex; min-height: 100vh; }
    .sidebar {
      width: 240px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 2.5rem;
    }
    .sidebar-logo { width: 32px; height: 32px; }
    .sidebar-title { font-size: 1.25rem; font-weight: 800; color: var(--primary-color); }
    .sidebar-nav a, .sidebar-nav button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.95rem;
      border: none;
      background: none;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    .sidebar-nav a.active, .sidebar-nav a:hover, .sidebar-nav button:hover {
      background-color: #eef2ff;
      color: var(--primary-color);
    }
    .sidebar-footer { margin-top: auto; font-size: 0.8rem; color: var(--text-secondary); text-align: center; }
    .main-content { flex: 1; padding: 2.5rem; overflow-y: auto; }
    .main-header { margin-bottom: 2rem; }
    .main-header h1 { font-size: 1.875rem; font-weight: 800; margin-bottom: 0.25rem; }
    .main-header p { color: var(--text-secondary); font-size: 1rem; }
    .filters { display: flex; gap: 1rem; margin-bottom: 2rem; align-items: center; }
    .filters label { font-weight: 600; font-size: 0.9rem; }
    .filters select {
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border-color);
      background-color: #fff;
      font-weight: 600;
    }
    .rankings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .ranking-panel {
      background-color: #fff;
      border-radius: var(--panel-radius);
      box-shadow: var(--panel-shadow);
      padding: 1.5rem;
    }
    .ranking-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .ranking-header h3 { font-size: 1.125rem; font-weight: 700; margin: 0; }
    .ranking-header button { background: none; border: none; color: var(--primary-color); font-weight: 600; cursor: pointer; }
    .ranking-list { list-style: none; }
    .ranking-list li {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    .ranking-list .posicion { font-size: 1.125rem; font-weight: 700; width: 2rem; text-align: center; }
    .ranking-list .info { flex: 1; }
    .ranking-list .nombre { font-weight: 600; }
    .ranking-list .detalle { font-size: 0.875rem; color: var(--text-secondary); }
    .ranking-list .valor { font-weight: 700; color: var(--primary-color); }
    .loader { text-align: center; padding: 2rem; color: var(--text-secondary); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: #fff; padding: 2rem; border-radius: var(--panel-radius); width: 90%; max-width: 600px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-header h2 { font-size: 1.5rem; }
    .modal-header button { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
  </style>
</head>
<body>
<div class="layout">
  <nav class="sidebar">
    <div>
      <div class="sidebar-header">
        <img src="/logo connecting.png" alt="Logo" class="sidebar-logo"/>
        <span class="sidebar-title">Connecting</span>
      </div>
      <div class="sidebar-nav">
        <a href="/inicio.html" class="active">Inicio</a>
        <a href="/leads.html">Leads</a>
        <a href="/costumers.html">Costumers</a>
        <a href="/Facturacion.html">Facturaci√≥n</a>
        <button onclick="logout()">Cerrar Sesi√≥n</button>
      </div>
    </div>
    <div class="sidebar-footer"><p>Connecting CRM 2024</p></div>
  </nav>

  <main class="main-content">
    <header class="main-header">
      <h1 id="saludo">Dashboard</h1>
      <p id="frase-inspiradora">Resumen de rendimiento de equipos y agentes.</p>
    </header>

    <div class="filters">
      <label for="mes-select">Mes:</label>
      <select id="mes-select">
        <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option><option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option><option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option><option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
      </select>
      <label for="anio-select">A√±o:</label>
      <select id="anio-select"></select>
    </div>

    <div class="rankings-grid">
      <div class="ranking-panel">
        <div class="ranking-header"><h3>Ranking por Equipo</h3><button onclick="abrirModal('equipos')">Ver todo</button></div>
        <ol id="ranking-equipos-list" class="ranking-list"></ol>
      </div>
      <div class="ranking-panel">
        <div class="ranking-header"><h3>Ranking por Agente</h3><button onclick="abrirModal('agentes')">Ver todo</button></div>
        <ol id="ranking-agentes-list" class="ranking-list"></ol>
      </div>
      <div class="ranking-panel">
        <div class="ranking-header"><h3>Ranking por Puntos</h3><button onclick="abrirModal('puntos')">Ver todo</button></div>
        <ol id="ranking-puntos-list" class="ranking-list"></ol>
      </div>
    </div>
  </main>
</div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Ranking Completo</h2>
      <button onclick="cerrarModal()">&times;</button>
    </div>
    <ol id="modal-list" class="ranking-list"></ol>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login.html';
      return;
    }

    const mesSelect = document.getElementById('mes-select');
    const anioSelect = document.getElementById('anio-select');
    const hoy = new Date();

    // Populate year filter
    for(let y = hoy.getFullYear() - 2; y <= hoy.getFullYear() + 1; y++) {
      let opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      anioSelect.appendChild(opt);
    }
    mesSelect.value = hoy.getMonth() + 1;
    anioSelect.value = hoy.getFullYear();

    const MEDAL_ICONS = ['ü•á', 'ü•à', 'ü•â'];

    const renderRanking = (listId, data, formatter, limit = 3) => {
      const listEl = document.getElementById(listId);
      if (!listEl) return;
      listEl.innerHTML = '<div class="loader">Cargando...</div>';
      if (!data || data.length === 0) {
        listEl.innerHTML = '<div class="loader">No hay datos para este per√≠odo.</div>';
        return;
      }
      const itemsToRender = data.slice(0, limit);
      listEl.innerHTML = itemsToRender.map(formatter).join('');
    };

    const formatEquipo = (item, idx) => `
      <li>
        <div class="posicion">${MEDAL_ICONS[idx] || idx + 1}</div>
        <div class="info">
          <div class="nombre">${item.equipo}</div>
        </div>
        <div class="valor">${item.ventas} ventas</div>
      </li>`;

    const formatAgente = (item, idx) => `
      <li>
        <div class="posicion">${MEDAL_ICONS[idx] || idx + 1}</div>
        <div class="info">
          <div class="nombre">${item.agente}</div>
          <div class="detalle">${item.equipo}</div>
        </div>
        <div class="valor">${item.ventas} ventas</div>
      </li>`;

    const formatPuntos = (item, idx) => `
      <li>
        <div class="posicion">${MEDAL_ICONS[idx] || idx + 1}</div>
        <div class="info">
          <div class="nombre">${item.agente}</div>
          <div class="detalle">${item.equipo}</div>
        </div>
        <div class="valor">${item.totalPuntos} pts</div>
      </li>`;

    let rankingsData = { equipos: [], agentes: [], puntos: [] };

    const fetchRankings = async (mes, anio) => {
      const headers = { 'Authorization': `Bearer ${token}` };
      try {
        const [equiposRes, agentesRes, puntosRes] = await Promise.all([
          fetch(`/api/rankings/equipos?mes=${mes}&anio=${anio}`, { headers }),
          fetch(`/api/rankings/agentes?mes=${mes}&anio=${anio}`, { headers }),
          fetch(`/api/rankings/puntos?mes=${mes}&anio=${anio}`, { headers })
        ]);

        if (equiposRes.status === 401 || agentesRes.status === 401 || puntosRes.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login.html';
          return;
        }

        rankingsData.equipos = (await equiposRes.json()).data || [];
        rankingsData.agentes = (await agentesRes.json()).data || [];
        rankingsData.puntos = (await puntosRes.json()).data || [];

        renderRanking('ranking-equipos-list', rankingsData.equipos, formatEquipo);
        renderRanking('ranking-agentes-list', rankingsData.agentes, formatAgente);
        renderRanking('ranking-puntos-list', rankingsData.puntos, formatPuntos);
      } catch (error) {
        console.error('Error al cargar rankings:', error);
        document.getElementById('ranking-equipos-list').innerHTML = '<div class="loader">Error al cargar datos.</div>';
        document.getElementById('ranking-agentes-list').innerHTML = '<div class="loader">Error al cargar datos.</div>';
        document.getElementById('ranking-puntos-list').innerHTML = '<div class="loader">Error al cargar datos.</div>';
      }
    };

    window.abrirModal = (tipo) => {
      document.getElementById('modal-overlay').style.display = 'flex';
      const modalList = document.getElementById('modal-list');
      let data, formatter, title;
      if (tipo === 'equipos') {
        data = rankingsData.equipos;
        formatter = formatEquipo;
        title = 'Ranking Completo por Equipo';
      } else if (tipo === 'agentes') {
        data = rankingsData.agentes;
        formatter = formatAgente;
        title = 'Ranking Completo por Agente';
      } else {
        data = rankingsData.puntos;
        formatter = formatPuntos;
        title = 'Ranking Completo por Puntos';
      }
      document.getElementById('modal-title').textContent = title;
      renderRanking('modal-list', data, formatter, data.length);
    };

    window.cerrarModal = () => {
      document.getElementById('modal-overlay').style.display = 'none';
    };

    window.logout = () => {
      localStorage.removeItem('token');
      window.location.href = '/logout';
    };

    mesSelect.addEventListener('change', () => fetchRankings(mesSelect.value, anioSelect.value));
    anioSelect.addEventListener('change', () => fetchRankings(mesSelect.value, anioSelect.value));
    document.getElementById('modal-overlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) cerrarModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') cerrarModal(); });

    fetchRankings(mesSelect.value, anioSelect.value);
  });
</script>
</body>
</html>