<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inicio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --sidebar-bg: #15344a;
      --sidebar-accent: #22b3ec;
      --sidebar-hover: #1ea1d8;
      --sidebar-text: #222;
      --sidebar-radius: 14px;
      --azul-oscuro: #1e293b;
      --azul-acento: #22b3ec;
      --gris-bg: #f5f7fa;
      --gris-borde: #e3e8ee;
      --gris-titulo: #edf3fa;
      --azul-celda: #f1f5fa;
      --radius: 15px;
      --sombra: 0 4px 24px 0 rgba(30,41,59,0.09);
      --trans: 0.18s;
      --panel-bg: #fff;
      --panel-radius: 22px;
      --panel-shadow: 0 8px 32px rgba(30,41,59,0.12);
      --ver-todo: #22b3ec;
      --ver-todo-hover: #1ea1d8;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Roboto', 'Montserrat', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: var(--gris-bg);
      color: var(--azul-oscuro);
    }
    .layout {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      background: linear-gradient(180deg, #f7fafd 0%, #f4f7fb 100%);
      min-width: 180px;
      width: 180px;
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 24px;
      height: 100vh;
      box-shadow: 0 6px 24px 0 rgba(30,41,59,0.10);
      font-weight: 700;
    }
    .sidebar-logo {
      width: 58px;
      height: 58px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      box-shadow: none;
      border-radius: 0;
    }
    .sidebar-logo img {
      width: 48px;
      height: 48px;
      display: block;
    }
    .sidebar-title {
      color: var(--sidebar-accent);
      font-size: 1.15em;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
      letter-spacing: .5px;
    }
    .sidebar-nav {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 13px;
      margin-bottom: 18px;
    }
    .sidebar-nav button {
      width: 95%;
      margin: 0 auto;
      padding: 12px 0;
      background: none;
      border: none;
      color: var(--sidebar-text);
      font-size: 1em;
      font-weight: 700;
      border-radius: 16px;
      text-align: left;
      padding-left: 18px;
      transition: background 0.15s, color 0.15s, box-shadow 0.18s;
      letter-spacing: 0.02em;
      box-shadow: none;
    }
    .sidebar-nav button.active, .sidebar-nav button:hover {
      background: var(--sidebar-accent);
      color: var(--sidebar-text);
      box-shadow: 0 2px 10px 0 #22b3ec55;
    }
    .sidebar-lema {
      color: var(--sidebar-accent);
      font-style: italic;
      font-size: 0.99em;
      opacity: 0.6;
      margin-top: auto;
      padding: 12px 10px 18px 10px;
      text-align: center;
      font-weight: 600;
    }

    .main-content {
      flex: 1;
      padding: 40px 0;
      background: var(--gris-bg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .dashboard-container {
      width: 100%;
      max-width: 1150px;
      margin: 0 auto;
      padding: 0 18px 24px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .panel-bienvenida-admin {
      background: linear-gradient(120deg, #f1fafe 62%, #e8f0fd 100%);
      border-radius: var(--panel-radius);
      box-shadow: var(--panel-shadow);
      padding: 0 0 36px 0;
      text-align: center;
      position: relative;
      overflow: hidden;
      margin-bottom: 42px;
      width: 100%;
      max-width: 980px;
    }
    .panel-bienvenida-admin .panel-header-img {
      width: 100%;
      height: 180px;
      overflow: hidden;
      border-radius: 22px 22px 0 0;
      background: #209dd5;
    }
    .panel-bienvenida-admin h2 {
      margin-top: 32px;
      color: #209dd5;
      font-weight: 900;
      font-size: 1.4em;
      letter-spacing: -1px;
    }
    .panel-bienvenida-admin .valores-cultura {
      display: flex;
      justify-content: center;
      gap: 22px;
      margin: 20px 0 12px 0;
      flex-wrap: wrap;
    }
    .valor-card {
      background: rgba(32,157,213,0.09);
      border-radius: 11px;
      padding: 13px 20px 12px 20px;
      box-shadow: 0 2px 6px #209dd52a;
      min-width: 110px;
      text-align: center;
    }
    .rankings-wrapper {
      display: flex;
      flex-direction: row;
      gap: 36px;
      justify-content: center;
      align-items: stretch;
      width: 100%;
      max-width: 980px;
      margin-bottom: 0;
    }
    .ranking-panel {
      flex: 1 1 0px;
      min-width: 280px;
      max-width: 340px;
      background: var(--panel-bg);
      border-radius: 15px;
      box-shadow: 0 3px 18px #209dd524;
      padding: 32px 18px 36px 22px;
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: relative;
      min-height: 260px;
    }
    @media (max-width: 1100px) {
      .dashboard-container, .rankings-wrapper, .panel-bienvenida-admin { max-width: 99vw; }
      .rankings-wrapper { gap: 20px;}
      .ranking-panel { min-width: 210px; max-width: 330px; }
    }
    @media (max-width: 900px) {
      .rankings-wrapper { gap: 10px;}
      .ranking-panel { min-width: 170px; max-width: 98vw;}
    }
    @media (max-width: 850px) {
      .rankings-wrapper { flex-direction: column; gap: 18px;}
      .ranking-panel { width: 100%; max-width: 99vw; min-width: unset; min-height: 0;}
    }
    .ranking-panel h3 {
      color: #209dd5;
      margin-top: 0;
      margin-bottom: 18px;
      font-weight: 800;
    }
    .ranking-panel ol {
      padding-left: 0;
      list-style: none;
      margin: 0;
      width: 100%;
    }
    .ranking-panel li {
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .ranking-panel li.opacity-low {
      opacity: 0.75;
    }
    .ver-todo-link {
      position: absolute;
      bottom: 14px;
      right: 22px;
      color: var(--ver-todo);
      font-weight: 600;
      font-size: 1em;
      cursor: pointer;
      border: none;
      background: none;
      outline: none;
      transition: color 0.15s;
    }
    .ver-todo-link:hover {
      color: var(--ver-todo-hover);
      text-decoration: underline;
    }
    /* MODAL */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(30,41,59,0.13);
      z-index: 99;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: modal-fade-in 0.18s;
    }
    @keyframes modal-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 48px #15344a22;
      padding: 38px 22px 26px 22px;
      max-width: 420px;
      width: 94vw;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .modal-close {
      position: absolute;
      top: 14px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.5em;
      color: #15344a;
      cursor: pointer;
      font-weight: bold;
      opacity: 0.7;
      transition: opacity 0.14s;
    }
    .modal-close:hover {
      opacity: 1;
    }
    .modal-content h3 {
      margin-top: 0;
      font-size: 1.25em;
      color: #209dd5;
      margin-bottom: 18px;
      font-weight: 800;
    }
    .modal-content ol {
      padding-left: 0;
      list-style: none;
      margin: 0;
      width: 100%;
    }
    .modal-content li {
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    @media (max-width: 700px) {
      .layout { flex-direction: column;}
      .sidebar { flex-direction: row; width: 100vw; min-height: 0; height: 70px; align-items: center; padding: 7px 0; }
      .sidebar-logo { margin: 0 12px 0 0; }
      .sidebar-title { font-size: 1em; margin-bottom: 0;}
      .sidebar-nav { flex-direction: row; gap: 0; }
      .sidebar-nav button { font-size: 1em; padding: 11px 6px; width: auto; border-radius: 7px; margin:0 3px; }
      .sidebar-lema { display: none;}
      .main-content { padding: 12px 2px; }
      .dashboard-container { padding: 0 2vw;}
      .panel-bienvenida-admin { padding-bottom: 20px; }
      .panel-bienvenida-admin .valores-cultura { flex-direction: column; gap: 7px; }
      .ranking-panel { padding: 15px 5px 16px 5px; font-size: 0.97em; }
      .ranking-panel h3 { font-size: 1em; }
      .ranking-panel li { font-size: 0.98em; }
      .modal-content { padding: 16px 4vw 12px 4vw; max-width: 98vw;}
    }
  </style>
</head>
<body>
<div class="layout">
  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <img src="logo connecting.png" alt="Logo Connecting"/>
    </div>
    <div class="sidebar-title">Connecting</div>
    <div class="sidebar-nav">
      <button class="active" onclick="location.href='inicio.html'">Inicio</button>
      <button onclick="location.href='lead.html'">Lead</button>
      <button onclick="location.href='costumer.html'">Costumer</button>
      <button onclick="location.href='Facturacion.html'">Facturacion</button>
      <button onclick="logout()">Cerrar sesión</button>
    </div>
    <div class="sidebar-lema">
      "Conectando tu éxito, un cliente a la vez"
    </div>
  </nav>
    <!-- MAIN CONTENT -->
    <main class="main-content">
      <div class="dashboard-container">
        <!-- Panel bienvenida y rankings -->
        <div class="panel-bienvenida-admin">
          <div class="panel-header-img">
            <svg width="100%" height="180" viewBox="0 0 600 180" fill="none" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="150" cy="90" rx="120" ry="70" fill="#22b3ec" opacity="0.23"/>
              <ellipse cx="470" cy="110" rx="80" ry="50" fill="#fff" opacity="0.14"/>
              <ellipse cx="320" cy="70" rx="70" ry="40" fill="#fff" opacity="0.10"/>
              <circle cx="500" cy="60" r="32" fill="#22b3ec" opacity="0.13"/>
              <circle cx="90" cy="60" r="18" fill="#fff" opacity="0.10"/>
              <!-- Luna -->
              <circle cx="300" cy="120" r="44" fill="#F4F7FB" stroke="#b7d7ef" stroke-width="3" opacity="0.98"/>
              <ellipse cx="320" cy="135" rx="6" ry="3" fill="#d9eaff" opacity="0.35"/>
              <ellipse cx="292" cy="145" rx="4" ry="2" fill="#d9eaff" opacity="0.25"/>
              <!-- Astronauta -->
              <g>
                <rect x="288" y="95" width="24" height="32" rx="8" fill="#fff" stroke="#209dd5" stroke-width="2"/>
                <circle cx="300" cy="98" r="12" fill="#fff" stroke="#209dd5" stroke-width="2"/>
                <ellipse cx="300" cy="103" rx="6" ry="3" fill="#b7d7ef" opacity="0.25"/>
                <ellipse cx="303" cy="98" rx="5" ry="4" fill="#22b3ec" opacity="0.45"/>
                <rect x="282" y="105" width="8" height="24" rx="4" transform="rotate(-20 282 105)" fill="#fff" stroke="#209dd5" stroke-width="2"/>
                <rect x="310" y="105" width="8" height="24" rx="4" transform="rotate(20 310 105)" fill="#fff" stroke="#209dd5" stroke-width="2"/>
                <rect x="292" y="125" width="7" height="18" rx="3" transform="rotate(-8 292 125)" fill="#fff" stroke="#209dd5" stroke-width="2"/>
                <rect x="301" y="128" width="7" height="18" rx="3" transform="rotate(8 301 128)" fill="#fff" stroke="#209dd5" stroke-width="2"/>
                <rect x="292" y="109" width="16" height="11" rx="3" fill="#d9eaff" opacity="0.45"/>
                <rect x="318" y="116" width="2" height="20" fill="#209dd5"/>
                <rect x="320" y="116" width="14" height="9" fill="#22b3ec" stroke="#209dd5" stroke-width="1"/>
                <rect x="324" y="119" width="6" height="3" fill="#fff"/>
              </g>
            </svg>
          </div>
          <h2 id="saludo"></h2>
          <div id="frase-inspiradora" style="font-size:1.13em;color:#1e293b;font-style:italic;margin-bottom:18px;"></div>
          <div class="valores-cultura" id="valores-cultura"></div>
          <div style="margin-top:16px;color:#b6c8d8;font-size:0.98em;font-style:italic;">
            Connecting CRM Administrativo
          </div>
        </div>
        <!-- FILTROS DE MES/AÑO PARA RANKING -->
        <div class="filtros-ranking" style="margin-bottom:30px; display:flex; gap:16px; align-items:center;">
          <label for="filtroRankingMes">Mes:</label>
          <select id="filtroRankingMes">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
          </select>
          <label for="filtroRankingAno">Año:</label>
          <select id="filtroRankingAno"></select>
        </div>
        <div class="rankings-wrapper">
          <div class="ranking-panel" id="ranking-equipos-panel">
            <h3>🏆 Ranking por Equipo</h3>
            <ol id="ranking-equipos-list"></ol>
            <button class="ver-todo-link" onclick="abrirModal('equipos')">Ver todo</button>
          </div>
          <div class="ranking-panel" id="ranking-agentes-panel">
            <h3>🌟 Ranking por Agente</h3>
            <ol id="ranking-agentes-list"></ol>
            <button class="ver-todo-link" onclick="abrirModal('agentes')">Ver todo</button>
          </div>
          <div class="ranking-panel" id="ranking-puntos-panel">
            <h3>⭐ Ranking por Puntos</h3>
            <ol id="ranking-puntos-list"></ol>
            <button class="ver-todo-link" onclick="abrirModal('puntos')">Ver todo</button>
          </div>
        </div>
      </div>
      <!-- MODAL -->
      <div id="modal-overlay" class="modal-overlay" style="display:none;">
        <div class="modal-content">
          <button class="modal-close" onclick="cerrarModal()" title="Cerrar">×</button>
          <h3 id="modal-title"></h3>
          <ol id="modal-list"></ol>
        </div>
      </div>
    </main>
  </div>
<script>
  // Valores y frases
  const valores = [
    { emoji: "🤝", valor: "Colaboración" },
    { emoji: "🏆", valor: "Excelencia" },
    { emoji: "💡", valor: "Innovación" }
  ];
  const frases = [
    "Liderar con integridad y visión: eso es Connecting.",
    "El éxito administrativo se construye con disciplina y pasión.",
    "Cada gestión es un paso hacia la excelencia.",
    "La confianza y la transparencia son nuestro mejor activo.",
    "¡Gracias por ser parte de nuestro crecimiento diario!",
    "El profesionalismo conecta sueños con resultados.",
    "Alcanzar la luna comienza con un primer paso, ¡gracias por darlo cada día!"
  ];

  function getSaludo(nombre) {
    const hora = new Date().getHours();
    let base = nombre ? `, ${nombre}` : "";
    if (hora < 12) return "¡Buenos días" + base + "!";
    if (hora < 19) return "¡Buenas tardes" + base + "!";
    return "¡Buenas noches" + base + "!";
  }
  function renderValores() {
    const cont = document.getElementById('valores-cultura');
    cont.innerHTML = valores.map(v =>
      `<div class="valor-card">
        <span style="font-size:1.4em;">${v.emoji}</span><br>
        <span style="color:#209dd5;font-weight:700;">${v.valor}</span>
      </div>`
    ).join('');
  }

  // Filtro año automático
  (function(){
    const yearNow = (new Date()).getFullYear();
    let anos = '';
    for (let y = yearNow - 2; y <= yearNow + 1; y++) {
      anos += `<option value="${y}">${y}</option>`;
    }
    document.getElementById('filtroRankingAno').innerHTML = anos;
    document.getElementById('filtroRankingMes').value = (new Date()).getMonth() + 1;
    document.getElementById('filtroRankingAno').value = yearNow;
  })();

  // Ranking mensual filtrable
  let leadsOriginal = [];
  let equiposRanking = [], agentesRanking = [], puntosRanking = [];

  async function cargarDashboard() {
    const bienvenida = await fetch('/api/welcome').then(r=>r.json())
      .catch(()=>({nombre:'Equipo administrativo'}));
    document.getElementById('saludo').textContent = getSaludo(bienvenida.nombre);
    document.getElementById('frase-inspiradora').textContent = frases[Math.floor(Math.random()*frases.length)];
    renderValores();

    leadsOriginal = await fetch('/api/leads').then(r=>r.json()).catch(()=>[]);
    actualizarRankingPorFiltro();
  }

  function filtrarPorMes(leads, mes, ano) {
    return leads.filter(doc => {
      // doc.fecha debe ser tipo "YYYY-MM-DD" o similar
      const fecha = new Date(doc.fecha);
      return (fecha.getMonth() + 1) === mes && fecha.getFullYear() === ano;
    });
  }

  function calcularRankingEquipos(leadsMes) {
    const mapeo = {};
    leadsMes.forEach(l => {
      if (!mapeo[l.equipo]) mapeo[l.equipo] = 0;
      mapeo[l.equipo]++;
    });
    let arr = Object.entries(mapeo).map(([nombre, ventas])=>({nombre, ventas}));
    arr.sort((a,b)=>b.ventas-a.ventas);
    const max = arr[0] ? arr[0].ventas : 1;
    arr.forEach(a => a.porc = Math.round((a.ventas/max)*100));
    return arr;
  }
  function calcularRankingAgentes(leadsMes) {
    const mapeo = {};
    leadsMes.forEach(l => {
      if (!mapeo[l.agente]) mapeo[l.agente] = {nombre:l.agente, equipo:l.equipo, ventas:0};
      mapeo[l.agente].ventas++;
    });
    let arr = Object.values(mapeo);
    arr.sort((a,b)=>b.ventas-a.ventas);
    return arr;
  }
  function calcularRankingPuntos(leadsMes) {
    const mapeo = {};
    leadsMes.forEach(l => {
      if (!mapeo[l.agente]) mapeo[l.agente] = {nombre:l.agente, equipo:l.equipo, puntos:0};
      mapeo[l.agente].puntos += (parseFloat(l.puntos)||0);
    });
    let arr = Object.values(mapeo);
    arr.sort((a,b)=>b.puntos-a.puntos);
    return arr;
  }

  function renderRankingEquipos(equipos, mostrarTodos) {
    const ol = document.getElementById(mostrarTodos ? 'modal-list' : 'ranking-equipos-list');
    const cantidad = mostrarTodos ? equipos.length : Math.min(4, equipos.length);
    ol.innerHTML = equipos.slice(0, cantidad).map((eq, idx) => `
      <li>
        <span style="font-size:1.3em;margin-right:8px;">${idx==0?'🥇':idx==1?'🥈':idx==2?'🥉':idx+1}</span>
        <span style="font-weight:700;">${eq.nombre}</span>
        <div style="flex:1;margin:0 7px;">
          <div style="height:8px;background:#e6f5fb;border-radius:4px;overflow:hidden;">
            <div style="width:${Math.min(100,eq.porc)}%;background:${idx==0?'#22b3ec':'#b6e0fb'};height:100%;border-radius:4px;"></div>
          </div>
        </div>
        <span style="font-weight:600;color:#209dd5;">${eq.ventas} ventas</span>
      </li>
    `).join('');
  }
  function renderRankingAgentes(agentes, mostrarTodos) {
    const ol = document.getElementById(mostrarTodos ? 'modal-list' : 'ranking-agentes-list');
    const cantidad = mostrarTodos ? agentes.length : Math.min(4, agentes.length);
    ol.innerHTML = agentes.slice(0, cantidad).map((ag, idx) => `
      <li>
        <span style="font-size:1.3em;margin-right:8px;">
          ${idx==0?'🥇':idx==1?'🥈':idx==2?'🥉':idx+1}
        </span>
        <div style="flex:1;">
          <div style="font-weight:700;">${ag.nombre}</div>
          <div style="font-size:0.97em;color:#209dd5;">${ag.equipo}</div>
        </div>
        <span style="font-weight:600;color:#209dd5;">${ag.ventas} ventas</span>
      </li>
    `).join('');
  }
  function renderRankingPuntos(puntos, mostrarTodos) {
    const ol = document.getElementById(mostrarTodos ? 'modal-list' : 'ranking-puntos-list');
    const cantidad = mostrarTodos ? puntos.length : Math.min(4, puntos.length);
    ol.innerHTML = puntos.slice(0, cantidad).map((p, idx) => `
      <li>
        <span style="font-size:1.3em;margin-right:8px;">
          ${idx==0?'🥇':idx==1?'🥈':idx==2?'🥉':idx+1}
        </span>
        <div style="flex:1;">
          <div style="font-weight:700;">${p.nombre}</div>
          <div style="font-size:0.97em;color:#209dd5;">${p.equipo}</div>
        </div>
        <span style="font-weight:600;color:#209dd5;">${p.puntos} pts</span>
      </li>
    `).join('');
  }

  function actualizarRankingPorFiltro() {
    const mes = parseInt(document.getElementById('filtroRankingMes').value, 10);
    const ano = parseInt(document.getElementById('filtroRankingAno').value, 10);
    const leadsMes = filtrarPorMes(leadsOriginal, mes, ano);

    window.equiposRanking = calcularRankingEquipos(leadsMes);
    window.agentesRanking = calcularRankingAgentes(leadsMes);
    window.puntosRanking = calcularRankingPuntos(leadsMes);

    renderRankingEquipos(window.equiposRanking, false);
    renderRankingAgentes(window.agentesRanking, false);
    renderRankingPuntos(window.puntosRanking, false);
  }

  document.getElementById('filtroRankingMes').addEventListener('change', actualizarRankingPorFiltro);
  document.getElementById('filtroRankingAno').addEventListener('change', actualizarRankingPorFiltro);

  // MODAL LÓGICA
  let currentModal = null;
  function abrirModal(tipo) {
    currentModal = tipo;
    document.getElementById('modal-overlay').style.display = "flex";
    if (tipo === "equipos") {
      document.getElementById('modal-title').textContent = "Ranking completo por Equipo";
      renderRankingEquipos(window.equiposRanking, true);
    } else if (tipo === "agentes") {
      document.getElementById('modal-title').textContent = "Ranking completo por Agente";
      renderRankingAgentes(window.agentesRanking, true);
    } else if (tipo === "puntos") {
      document.getElementById('modal-title').textContent = "Ranking completo por Puntos";
      renderRankingPuntos(window.puntosRanking, true);
    }
  }
  function cerrarModal() {
    document.getElementById('modal-overlay').style.display = "none";
    currentModal = null;
  }
  function logout() {
    window.location.href = 'logout';
  }
  document.addEventListener('keydown', function(e){
    if (e.key === "Escape") cerrarModal();
  });
  document.getElementById('modal-overlay').addEventListener('click', function(e){
    if (e.target === this) cerrarModal();
  });

  cargarDashboard();
</script>
</body>
</html>