<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> Connecting </title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    :root {
      --sidebar-bg: #15344a;
      --sidebar-accent: #22b3ec;
      --sidebar-hover: #1ea1d8;
      --sidebar-text: #222;
      --sidebar-radius: 14px;
      --azul-oscuro: #1e293b;
      --azul-acento: #22b3ec;
      --gris-bg: #f5f7fa;
      --gris-borde: #e3e8ee;
      --gris-titulo: #edf3fa;
      --azul-celda: #f1f5fa;
      --radius: 15px;
      --sombra: 0 4px 24px 0 rgba(30,41,59,0.09);
      --trans: 0.18s;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Roboto', 'Montserrat', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: var(--gris-bg);
      color: var(--azul-oscuro);
    }
    .layout {
      display: flex;
      min-height: 100vh;
    }
    /* SIDEBAR - ESTILO REPORTS, NEGRITA */
    .sidebar {
      background: linear-gradient(180deg, #f7fafd 0%, #f4f7fb 100%);
      min-width: 180px;
      width: 180px;
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 24px;
      height: 100vh;
      box-shadow: 0 6px 24px 0 rgba(30,41,59,0.10);
      font-weight: 700;
    }
    .sidebar-logo {
      width: 58px;
      height: 58px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      box-shadow: none;
      border-radius: 0;
    }
    .sidebar-logo img {
      width: 48px;
      height: 48px;
      display: block;
    }
    .sidebar-title {
      color: var(--sidebar-accent);
      font-size: 1.15em;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
      letter-spacing: .5px;
    }
    .sidebar-nav {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 13px;
      margin-bottom: 18px;
    }
    .sidebar-nav button {
      width: 95%;
      margin: 0 auto;
      padding: 12px 0;
      background: none;
      border: none;
      color: var(--sidebar-text);
      font-size: 1em;
      font-weight: 700;
      border-radius: 16px;
      text-align: left;
      padding-left: 18px;
      transition: background 0.15s, color 0.15s;
      letter-spacing: 0.02em;
    }
    .sidebar-nav button.active, .sidebar-nav button:hover {
      background: var(--sidebar-accent);
      color: var(--sidebar-text);
    }
    .sidebar-lema {
      color: var(--sidebar-accent);
      font-style: italic;
      font-size: 0.99em;
      opacity: 0.6;
      margin-top: auto;
      padding: 12px 10px 18px 10px;
      text-align: center;
      font-weight: 600;
    }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      padding: 40px 50px;
      background: var(--gris-bg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    /* LEAD FORM */
    .lead-content-row {
      display: flex;
      gap: 30px;
      width: 100%;
      align-items: flex-start;
    }
    .charts-graphs-row {
      display: flex;
      flex-direction: column;
      gap: 22px;
      width: 100%;
      align-items: flex-start;
      justify-content: space-between;
    }
    @media (max-width: 1100px) {
      .charts-graphs-row {
        flex-direction: column;
        gap: 18px;
      }
    }
    .form-section {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px #0001;
      padding: 42px 38px 36px 38px;
      max-width: 480px;
      width: 100%;
      margin: 44px auto;
      flex: 1;
      align-self: flex-start;
      display: flex;
      flex-direction: column;
    }
    .form-section h2 {
      font-weight: 700;
      font-size: 2em;
      color: #183153;
      margin-bottom: 28px;
      margin-top: 0;
    }
    .form-group { margin-bottom: 18px;}
    .form-section label {
      color: #25a9dd;
      font-weight: 700;
      margin-bottom: 7px;
      display: block;
    }
    .form-section label[for="fecha-lead"] {
      color: #183153;
    }
    .form-section input, .form-section select {
      background: #f8fcff;
      border-radius: 7px;
      border: 1.5px solid #e4e6f1;
      padding: 13px 15px;
      font-size: 1.12em;
      width: 100%;
      margin-top: 2px;
    }
    .form-section button[type="submit"] {
      background: #25a9dd;
      color: #fff;
      border-radius: 9px;
      border: none;
      font-weight: 700;
      font-size: 1.18em;
      padding: 16px 0;
      width: 100%;
      margin-top: 9px;
      transition: background 0.2s;
    }
    .form-section button[type="submit"]:hover {
      background: #183153;
    }
    /* CHARTS SECTION */
    .charts-section {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 15px;
      height: 100%;
      width: 100%;
      padding: 15px;
      box-sizing: border-box;
    }
    .charts-section .charts-filter { margin-bottom: 20px; padding: 10px 15px; background: #f3f7fa; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 14px;}
    .charts-section .charts-filter label { font-weight: 600; margin-bottom: 0;}
    .charts-section .charts-filter input[type="date"] { padding: 7px 10px; border-radius: 6px; border: 1px solid #b4c5d4;}
    .charts-section .charts-filter button { width: auto; padding: 9px 20px; margin: 0; background: #2196f3; border: none; color: white; border-radius: 6px; font-weight: 700; cursor: pointer; transition: background-color 0.3s;}
    .charts-section .charts-filter button:hover { background: #126de4; }
    .chart-container { 
      background: #fff; 
      padding: 15px; 
      border: 1px solid #e2e8f0; 
      border-radius: 8px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
      width: 100%;
      max-width: 100%;
      display: flex; 
      flex-direction: column;
      height: auto;
      min-height: 300px;
      margin: 0 0 15px 0;
      position: relative;
    }
    .chart-container h3 { margin-top: 0; font-weight: 700; margin-bottom: 10px;}
    .chart-container {
      position: relative;
      width: 100%;
      min-height: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      overflow: hidden;
    }
    .chart-canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 400px;
      min-height: 250px;
      display: block;
      background: transparent;
      position: relative;
      margin: 10px auto 0;
      aspect-ratio: 4/3;
    }
    .no-data-msg { color: #d32f2f; font-weight: bold; text-align: center; margin-top: 10px;}
    @media (max-width: 1100px) {
      .charts-section .charts-filter, .form-section { padding: 12px 7vw; }
      .lead-content-row { flex-direction: column; gap: 13px; }
      .main-content { padding: 14px 2vw; }
    }
    @media (max-width: 700px) {
      .layout { flex-direction: column;}
      .sidebar { flex-direction: row; width: 100vw; min-height: 0; height: 70px; align-items: center; padding: 7px 0; }
      .sidebar-logo { margin: 0 12px 0 0; }
      .sidebar-title { font-size: 1em; margin-bottom: 0;}
      .sidebar-nav { flex-direction: row; gap: 0; }
      .sidebar-nav button { font-size: 1em; padding: 11px 6px; width: auto; border-radius: 7px; margin:0 3px; }
      .sidebar-lema { display: none;}
      .main-content { padding: 12px 2px; }
      .lead-content-row { flex-direction: column; gap: 7px;}
      .form-section { padding: 13px 7px;}
      .chart-container {padding: 7px 2vw;}
      .charts-section .charts-filter {padding: 7px 2vw;}
      .chart-canvas { aspect-ratio: 16/12; }
    }
  </style>
</head>
<body>
<div class="layout">
  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <img src="logo connecting.png" alt="Logo Connecting"/>
    </div>
    <div class="sidebar-title">Connecting</div>
    <div class="sidebar-nav">
      <button onclick="location.href='inicio.html'">Inicio</button>
      <button class="active" onclick="location.href='lead.html'">Lead</button>
      <button onclick="location.href='costumer.html'">Costumer</button>
      <button onclick="location.href='Facturacion.html'">Facturacion</button>
      <button onclick="logout()">Cerrar sesión</button>
    </div>
    <div class="sidebar-lema">
      "Conectando tu éxito, un cliente a la vez"
    </div>
  </nav>
  <main class="main-content">
    <div class="lead-content-row">
      <!-- FORMULARIO -->
      <section class="form-section" id="form-panel">
        <h2>Formulario de Registro</h2>
        <form id="crmForm">
          <div class="form-group">
            <label for="fecha-lead" style="color: #183153;">Fecha</label>
            <input type="date" id="fecha-lead" name="fecha-lead" />
          </div>
          <div class="form-group">
            <label for="team">Team</label>
            <select id="team" required>
              <option value="">Seleccione team</option>
              <option value="Team Irania">Team Irania</option>
              <option value="Team Pleitez">Team Pleitez</option>
              <option value="Team Roberto">Team Roberto</option>
              <option value="Team Lineas">Team Lineas</option>
              <option value="Team Randal">Team Randal</option>
              <option value="Team Marisol">Team Marisol</option>
            </select>
          </div>
          <div class="form-group">
            <label for="agent">Agente</label>
            <select id="agent" required>
              <option>Seleccione Agente</option>
            </select>
          </div>
          <div class="form-group">
            <label for="producto">Producto</label>
            <select id="producto" required>
              <option>Seleccione Producto</option>
            </select>
          </div>
          <div class="form-group">
            <label for="puntaje">Puntaje</label>
            <select id="puntaje" required>
              <option>Seleccione Puntaje</option>
              <option>Sin Puntaje</option>
              <option>0.25</option>
              <option>0.35</option>
              <option>1.0</option>
              <option>1.25</option>
              <option>1.50</option>
            </select>
          </div>
          <div class="form-group">
            <label for="cuenta">Cuenta Google</label>
            <select id="cuenta" required>
              <option>Seleccione Cuenta</option>
              <option>Cuenta Alexis</option>
              <option>Cuenta Eduardo</option>
              <option>Cuenta Israel</option>
              <option>Cuenta Lineas</option>
            </select>
          </div>
          <div class="form-group">
            <label for="telefono">Teléfono</label>
            <input type="text" id="telefono" placeholder="(XXX) XXX-XXXX" required/>
          </div>
          <div class="form-group">
            <label for="direccion">Dirección</label>
            <input type="text" id="direccion" placeholder="Dirección del cliente" required/>
          </div>
          <div class="form-group" style="margin-bottom: 26px;">
            <label for="zip">ZIP Code</label>
            <input type="text" id="zip" placeholder="Código ZIP" required/>
          </div>
          <button type="submit">Guardar Lead</button>
        </form>
      </section>
      <!-- GRÁFICAS -->
      <section class="charts-section" id="charts-panel">
        <div class="charts-filter">
          <h2 class="chart-title">Estadísticas de Leads</h2>
          <div class="date-filters">
  <input type="date" id="dia-filtro" style="margin-right:10px;">
  <select id="mes-filtro"></select>
  <select id="anio-filtro"></select>
  <button id="actualizar-graficas">Actualizar</button>
          </div>
        </div>
        <!-- Contenedor para ambas gráficas alineadas -->
        <div class="charts-graphs-row">
          <div class="chart-card" style="width: 100%;">
        <h3 class="chart-subtitle" style="font-size: 1.2rem; font-weight: 600; margin: 0 0 15px 0; color: #333;">Ventas y Puntaje por Team</h3>
        <div class="chart-container">
          <canvas id="team-chart" class="chart-canvas"></canvas>
        </div>
      </div>
      <div class="chart-card" style="width: 100%;">
        <h3 class="chart-subtitle" style="font-size: 1.2rem; font-weight: 600; margin: 0 0 15px 0; color: #333;">Ventas por Producto</h3>
        <div class="chart-container">
          <canvas id="product-chart" class="chart-canvas"></canvas>
        </div>
      </div>
        </div>
      </section>
    </div>
  </main>
</div>
<script>
  // SIDEBAR logout
  function logout() {
    fetch('/logout', { credentials: 'include' })
      .then(() => window.location.href = '/login.html');
  }

  // --- ARRAYS ---
  const equipos = ["Team Irania", "Team Pleitez", "Team Roberto", "Team Lineas", "Team Randal", "Team Marisol"];
  
  // --- FUNCIONES PARA MÉTRICAS DE VENTAS ---
  async function cargarMetricasVentas() {
    // Esta función está obsoleta ya que no hay elementos en el DOM para mostrar las métricas
    // Se mantiene por compatibilidad pero no realiza ninguna acción
    return;
  }

  // LÓGICA PRINCIPAL - Se ejecuta cuando el DOM está completamente cargado
  document.addEventListener("DOMContentLoaded", () => {
    // --- INICIALIZACIÓN DE ELEMENTOS ---
    const selects = {
      team: document.getElementById("team"),
      agent: document.getElementById("agent"),
      producto: document.getElementById("producto"),
      cuenta: document.getElementById("cuenta"),
      puntaje: document.getElementById("puntaje")
    };
    const mesFiltro = document.getElementById('mes-filtro');
    const anioFiltro = document.getElementById('anio-filtro');
    const actualizarBtn = document.getElementById('actualizar-graficas');
    const crmForm = document.getElementById("crmForm");

    // --- DATOS PARA LOS SELECTS ---
    const data = {
      teams: {
        "Team Irania": ["Irania", "Michael", "Giselle"],
        "Team Pleitez": ["Pleitez", "Kevin", "Nelson"],
        "Team Roberto": ["Roberto", "Santos", "Erick"],
        "Team Lineas": ["Dania", "Genesis", "Ofelia"],
        "Team Randal": ["Randal", "Josue", "Elian"],
        "Team Marisol": ["Marisol", "Isabella", "Naidelyn"],
      },
      productos: [], // Se llenará dinámicamente con fetch
      cuentas: ["Nueva", "Winback", "Agregado"]
    };

    // --- LLENADO DE SELECTS DEL FORMULARIO ---
    async function llenarProductosDinamicamente() {
      try {
        // Usar la misma lista de productos que está definida en el backend
        const PRODUCTOS_FIJOS = [
          "ATT AIR",
          "FRONTIER 5 GIG",
          "INTERNET + TELEFONO + TV",
          "FRONTIER",
          "FRONTIER INTERNET SERVICIOS"
        ];
        
        // Actualizar el select de productos
        if (selects.producto) {
          selects.producto.innerHTML = '<option value="">Seleccione Producto</option>' + 
            PRODUCTOS_FIJOS.map(p => `<option value="${p}">${p}</option>`).join('');
          window.LISTA_PRODUCTOS = PRODUCTOS_FIJOS;
        }
      } catch (e) {
        console.error('Error al cargar productos:', e);
        if (selects.producto) {
          selects.producto.innerHTML = '<option value="">(Error cargando productos)</option>';
        }
        window.LISTA_PRODUCTOS = [];
      }
    }

    async function llenarSelects() {
      Object.keys(data.teams).forEach(team => selects.team.add(new Option(team, team)));
      data.cuentas.forEach(c => selects.cuenta.add(new Option(c, c)));
      await llenarProductosDinamicamente();
    }

    llenarSelects();

    selects.team.addEventListener("change", function () {
      selects.agent.innerHTML = '<option>Seleccione Agente</option>';
      if (this.value && data.teams[this.value]) {
        data.teams[this.value].forEach(agent => selects.agent.add(new Option(agent, agent)));
      }
    });

    document.getElementById('fecha-lead').value = new Date().toISOString().slice(0, 10);

    // --- LLENADO DE FILTROS DE FECHA PARA GRÁFICAS ---
    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const anioActual = new Date().getFullYear();
    meses.forEach((mes, i) => mesFiltro.add(new Option(mes, i + 1))); // Meses en MongoDB son 1-12, no 0-11
    for (let i = anioActual; i >= 2022; i--) anioFiltro.add(new Option(i, i));
    mesFiltro.value = new Date().getMonth() + 1; // Ajuste para MongoDB
    anioFiltro.value = anioActual;

    // --- LÓGICA DE GRÁFICAS ---
    let teamChartInstance = null;
    let productChartInstance = null;

    // Función para limpiar un gráfico existente
    function limpiarGrafico(chartInstance) {
      if (chartInstance) {
        try {
          chartInstance.destroy();
        } catch (e) {
          console.warn('Error al destruir gráfico:', e);
        }
      }
      return null;
    }

    // Función para limpiar un contenedor de gráfico
    function limpiarContenedor(elementId) {
      const container = document.getElementById(elementId);
      if (!container) return null;
      
      // Limpiar el contenedor
      container.innerHTML = '';
      
      // Crear un nuevo canvas
      const newCanvas = document.createElement('canvas');
      newCanvas.id = elementId + '-canvas';
      container.appendChild(newCanvas);
      
      return newCanvas;
    }

    async function crearGraficas(mes, anio, dia) {
      // Limpiar instancias anteriores
      teamChartInstance = limpiarGrafico(teamChartInstance);
      productChartInstance = limpiarGrafico(productChartInstance);
      
      try {
        // Verificar que los elementos del DOM existan
        const teamChartContainer = document.getElementById('team-chart');
        const productChartContainer = document.getElementById('product-chart');
        
        if (!teamChartContainer || !productChartContainer) {
          console.error('No se encontraron los contenedores de las gráficas');
          return;
        }
        
        // Limpiar contenedores y obtener referencias a los canvas
        const teamCanvas = limpiarContenedor('team-chart');
        const productCanvas = limpiarContenedor('product-chart');
        
        if (!teamCanvas || !productCanvas) {
          console.error('No se pudieron crear los elementos canvas');
          return;
        }
        
        // Mostrar mensaje de carga
        teamChartContainer.innerHTML = '<div class="chart-loading">Cargando datos...</div>';
        productChartContainer.innerHTML = '<div class="chart-loading">Cargando datos...</div>';
        
        // Validar fechas
        const hoy = new Date();
        let params = new URLSearchParams();
        
        if (dia) {
          // Validar que la fecha no sea futura
          const fechaDia = new Date(dia);
          if (fechaDia > hoy) {
            console.warn('No se pueden mostrar datos para fechas futuras');
            dia = null; // Ignorar el filtro de día si es futuro
          } else {
            params.append('dia', dia);
          }
        }
        
        // Si no hay día o era inválido, usar mes y año
        if (!dia) {
          // Validar mes y año
          const mesNum = mes ? parseInt(mes) : hoy.getMonth() + 1;
          const anioNum = anio ? parseInt(anio) : hoy.getFullYear();
          
          // Asegurar que el mes esté en rango 1-12
          if (mesNum < 1 || mesNum > 12) {
            console.warn('Mes fuera de rango, usando mes actual');
            mes = hoy.getMonth() + 1;
          } else {
            mes = mesNum;
          }
          
          // Asegurar que el año sea razonable (ej. no más de 10 años en el futuro)
          if (anioNum > hoy.getFullYear() + 10) {
            console.warn('Año en el futuro distante, usando año actual');
            anio = hoy.getFullYear();
          } else {
            anio = anioNum;
          }
          
          params.append('mes', mes);
          params.append('anio', anio);
        }
        
        console.log('Obteniendo datos para', dia ? `dia=${dia}` : `mes=${mes}, anio=${anio}`);
        
        // Obtener token de autenticación
        const token = localStorage.getItem('token');
        if (!token) {
          console.error('No se encontró el token de autenticación');
          return;
        }
        
        // Configuración común para las peticiones fetch
        const fetchOptions = {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        };
        
        // Obtener datos de equipos y productos en paralelo
        const [equiposRes, productosRes] = await Promise.all([
          fetch(`/api/rankings/equipos?${params.toString()}`, fetchOptions),
          fetch(`/api/rankings/productos?${params.toString()}`, fetchOptions)
        ]);

        if (!equiposRes.ok || !productosRes.ok) {
          console.error('Error en respuestas:', equiposRes.status, productosRes.status);
          throw new Error('Error al obtener datos de las gráficas');
        }

        const equiposData = await equiposRes.json();
        const productosData = await productosRes.json();

        // Verificar que los datos tengan el formato esperado
        if (!equiposData || !equiposData.data || !Array.isArray(equiposData.data)) {
          console.error('Formato de datos de equipos inválido:', equiposData);
          throw new Error('Formato de datos de equipos inválido');
        }
        
        if (!productosData || !productosData.data || !Array.isArray(productosData.data)) {
          console.error('Formato de datos de productos inválido:', productosData);
          throw new Error('Formato de datos de productos inválido');
        }

        // Lista de productos que deben aparecer siempre en la gráfica
        let productosLabels = productosData.data.map(p => p.producto || '').filter(Boolean);
        if (window.LISTA_PRODUCTOS && Array.isArray(window.LISTA_PRODUCTOS) && window.LISTA_PRODUCTOS.length > 0) {
          productosLabels = window.LISTA_PRODUCTOS;
        }
        
        // Mapear datos de ventas a la lista dinámica
        const productosVentasMap = {};
        productosData.data.forEach(p => { 
          if (p.producto) {
            productosVentasMap[p.producto] = p.ventas || 0;
          }
        });
        
        const productosDataFinal = productosLabels.map(p => productosVentasMap[p] || 0);

        // Obtener referencias a los canvas
        const teamChartCanvas = document.getElementById('team-chart-canvas');
        const productChartCanvas = document.getElementById('product-chart-canvas');

        // Crear gráfica de equipos
        if (teamChartCanvas) {
          const teamCtx = teamChartCanvas.getContext('2d');
          if (teamCtx) {
            teamChartInstance = new Chart(teamCtx, {
              type: 'bar',
              data: {
                labels: equiposData.data.map(e => e.team || 'Sin equipo').filter(Boolean),
                datasets: [{
                  label: 'Ventas',
                  data: equiposData.data.map(e => e.ventas || 0),
                  backgroundColor: '#22b3ec',
                }, {
                  label: 'Puntaje',
                  data: equiposData.data.map(e => e.puntaje || 0),
                  backgroundColor: '#ef4444',
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: { 
                  legend: { position: 'top' }, 
                  datalabels: { 
                    anchor: 'end', 
                    align: 'end', 
                    formatter: v => Math.round(v*100)/100, 
                    color: '#333', 
                    font: { weight: 'bold' } 
                  }
                },
                scales: { 
                  y: { 
                    beginAtZero: true,
                    ticks: {
                      precision: 0
                    }
                  }
                }
              },
              plugins: [ChartDataLabels]
            });
          }
        }

        // Crear gráfica de productos
        if (productChartCanvas) {
          const productCtx = productChartCanvas.getContext('2d');
          if (productCtx) {
            productChartInstance = new Chart(productCtx, {
              type: 'bar',
              data: {
                labels: productosLabels,
                datasets: [{
                  label: 'Ventas por Producto',
                  data: productosDataFinal,
                  backgroundColor: '#2ba6cb',
                  borderColor: '#1e293b',
                  borderWidth: 2,
                  borderRadius: 8,
                  barThickness: 'flex',
                  maxBarThickness: 30,
                  minBarLength: 0
                }]
              },
              options: {
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: { 
                  legend: { display: false }, 
                  datalabels: { 
                    anchor: 'end', 
                    align: 'end', 
                    color: '#333',
                    font: { weight: 'bold' },
                    formatter: v => Math.round(v*100)/100
                  } 
                },
                scales: { 
                  y: { 
                    beginAtZero: true,
                    ticks: {
                      precision: 0
                    }
                  },
                  x: { 
                    ticks: { 
                      autoSkip: false, 
                      maxRotation: 90, 
                      minRotation: 45 
                    } 
                  } 
                }
              },
              plugins: [ChartDataLabels]
            });
          }
        }
      } catch (error) {
        console.error("Error al crear gráficas:", error);
        alert("Error al cargar las gráficas. Revisa la consola para más detalles.");
      }
    }

    // Función para actualizar gráficas con los filtros seleccionados
    function actualizarGraficas() {
      const dia = document.getElementById('dia-filtro').value;
      if (dia) {
        crearGraficas(null, null, dia);
      } else {
        crearGraficas(mesFiltro.value, anioFiltro.value, null);
      }
    }

    // Eventos para actualizar gráficas
    actualizarBtn.addEventListener('click', actualizarGraficas);
    
    // Carga inicial de métricas y gráficas
    cargarMetricasVentas();
    actualizarGraficas();
    
    // Actualizar métricas cada minuto (opcional)
    setInterval(cargarMetricasVentas, 60000);

    // --- LÓGICA DE FORMULARIO ---
    crmForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const form = e.target;
      const puntajeVal = form.puntaje.value;
      const body = {
        dia_venta: form['fecha-lead'].value,
        team: form.team.value,
        agent: form.agent.value,
        producto: form.producto.value,
        puntaje: puntajeVal === "Sin Puntaje" || puntajeVal === "Seleccione Puntaje" ? 0 : parseFloat(puntajeVal),
        cuenta: form.cuenta.value,
        telefono: form.telefono.value,
        direccion: form.direccion.value,
        zip: form.zip.value,
      };

      const token = localStorage.getItem('token');
      fetch("/api/leads", { 
        method: "POST", 
        headers: { 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }, 
        body: JSON.stringify(body) 
      })
        .then(res => {
          if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
          return res.json();
        })
        .then(() => {
          alert("Lead guardado exitosamente.");
          crmForm.reset();
          document.getElementById('fecha-lead').value = new Date().toISOString().slice(0,10);
          actualizarGraficas();
        })
        .catch(error => {
          console.error("Error al guardar lead:", error);
          alert("Hubo un error al guardar el lead.");
        });
    });
  });
</script>
</body>
</html>