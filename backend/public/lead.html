<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connecting</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --sidebar-bg: #15344a;
      --sidebar-accent: #22b3ec;
      --sidebar-hover: #1ea1d8;
      --sidebar-text: #222;
      --sidebar-radius: 14px;
      --azul-oscuro: #1e293b;
      --azul-acento: #22b3ec;
      --gris-bg: #f5f7fa;
      --gris-borde: #e3e8ee;
      --gris-titulo: #edf3fa;
      --azul-celda: #f1f5fa;
      --radius: 15px;
      --sombra: 0 4px 24px 0 rgba(30,41,59,0.09);
      --trans: 0.18s;
      --form-width: 420px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Roboto', 'Montserrat', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: var(--gris-bg);
      color: var(--azul-oscuro);
    }
    .layout {
      display: flex;
      min-height: 100vh;
    }
    /* SIDEBAR - ESTILO REPORTS, NEGRITA */
    .sidebar {
      background: linear-gradient(180deg, #f7fafd 0%, #f4f7fb 100%);
      min-width: 180px;
      width: 180px;
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 24px;
      height: 100vh;
      box-shadow: 0 6px 24px 0 rgba(30,41,59,0.10);
      font-weight: 700;
    }
    .graph-canvas {
      width: 100% !important;
      height: calc(100% - 35px) !important; /* Restar espacio del título */
      min-height: 220px;
      max-height: 100%;
    }
    .graph-container {
      min-height: 350px;
      height: 100%;
      max-height: 650px;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      overflow: hidden;
      box-sizing: border-box;
      width: 100%;
      margin: 0 auto;
    }
    .graph-container h3 {
      font-size: 0.95em;
      margin: 0 0 15px 0;
      padding-bottom: 8px;
      color: var(--azul-oscuro);
      border-bottom: 1px solid var(--gris-borde);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar-logo {
      width: 58px;
      height: 58px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      box-shadow: none;
      border-radius: 0;
    }
    .sidebar-logo img {
      width: 48px;
      height: 48px;
      display: block;
    }
    .sidebar-title {
      color: var(--sidebar-accent);
      font-size: 1.15em;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
      letter-spacing: .5px;
    }
    .sidebar-nav {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 13px;
      margin-bottom: 18px;
    }
    .sidebar-nav button {
      width: 95%;
      margin: 0 auto;
      padding: 12px 0;
      background: none;
      border: none;
      color: var(--sidebar-text);
      font-size: 1em;
      font-weight: 700;
      border-radius: 16px;
      text-align: left;
      padding-left: 18px;
      transition: background 0.15s, color 0.15s;
      letter-spacing: 0.02em;
    }
    .sidebar-nav button.active, .sidebar-nav button:hover {
      background: var(--sidebar-accent);
      color: var(--sidebar-text);
    }
    .sidebar-lema {
      color: var(--sidebar-accent);
      font-style: italic;
      font-size: 0.99em;
      opacity: 0.6;
      margin-top: auto;
      padding: 12px 10px 18px 10px;
      text-align: center;
      font-weight: 600;
    }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      padding: 20px 30px;
      overflow-y: auto;
      display: flex;
      gap: 25px;
      width: 100%;
      max-width: 100%;
      height: calc(100vh - 40px);
      box-sizing: border-box;
    }
    /* LEAD FORM */
    .lead-content-row {
      display: flex;
      flex-direction: row;
      gap: 25px;
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 20px;
      align-items: stretch;
      box-sizing: border-box;
      min-height: 100vh;  /* Asegura que ocupe al menos toda la altura de la pantalla */
    }
    .graphs-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 30px;
      min-width: 0;
      width: 100%;
      max-width: 100%;
      height: 100%;
      min-height: 100%;
      box-sizing: border-box;
      padding: 20px 10px;
      overflow-y: auto;
    }
    
    .graph-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      overflow: hidden;
      box-sizing: border-box;
      width: 100%;
      min-height: 0;  /* Permite que se encoja si es necesario */
    }
    .form-section {
      background: white;
      border-radius: var(--radius);
      padding: 30px 30px;
      box-shadow: var(--sombra);
      width: 410px;
      min-width: 400px;
      flex-shrink: 100;
      overflow-y: auto;
      height: 1000%;
      max-height: 100%;
      border: 1px solid var(--gris-borde);
      position: sticky;
      top: 0;
    }
    .form-section h2 {
      font-weight: 700;
      font-size: 2em;
      color: #183153;
      margin-bottom: 28px;
      margin-top: 0;
    }
    .form-group { margin-bottom: 18px;}
    .form-section label {
      color: #25a9dd;
      font-weight: 700;
      margin-bottom: 7px;
      display: block;
    }
    .form-section label[for="fecha-lead"] {
      color: #183153;
    }
    .form-section input, .form-section select {
      background: #f8fcff;
      border-radius: 7px;
      border: 1.5px solid #e4e6f1;
      padding: 13px 15px;
      font-size: 1.12em;
      width: 100%;
      margin-top: 2px;
    }
    .form-section button[type="submit"] {
      background: #25a9dd;
      color: #fff;
      border-radius: 9px;
      border: none;
      font-weight: 700;
      font-size: 1.18em;
      padding: 16px 0;
      width: 100%;
      margin-top: 9px;
      transition: background 0.2s;
    }
    .form-section button[type="submit"]:hover {
      background: #183153;
    }
    .graph-container {
      min-height: 300px;
      height: 100%;
      max-height: 400px;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--sombra);
      padding: 20px;
      overflow: hidden;
      box-sizing: border-box;
      width: 100%;
    }
    
    @media (max-width: 1100px) {
      .lead-content-row { 
        flex-direction: column; 
        gap: 20px; 
        max-height: none;
      }
      .main-content { 
        padding: 15px; 
        height: auto;
      }
      .form-section {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        position: static;
      }
    }
    @media (max-width: 700px) {
      .layout { flex-direction: column;}
      .sidebar { flex-direction: row; width: 100vw; min-height: 0; height: 70px; align-items: center; padding: 7px 0; }
      .sidebar-logo { margin: 0 12px 0 0; }
      .sidebar-title { font-size: 1em; margin-bottom: 0;}
      .sidebar-nav { flex-direction: row; gap: 0; }
      .sidebar-nav button { font-size: 1em; padding: 11px 6px; width: auto; border-radius: 7px; margin:0 3px; }
      .sidebar-lema { display: none;}
      .main-content { 
        padding: 12px 2px; 
        flex-direction: column;
      }
      .lead-content-row { 
        flex-direction: column; 
        gap: 12px;
        max-width: 100%;
      }
      .form-section, .graphs-section { 
        width: 100%;
        max-width: 100%;
        padding: 13px 7px;
      }
      .graphs-section {
        grid-template-columns: 1fr !important;
      }
    }
    /* Estilos para el filtro de fecha */
    .date-filter-container {
      width: 100%;
      margin-bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .date-filter {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .date-filter label {
      color: #15344a;
      font-weight: 600;
      margin-right: 5px;
    }
    
    .date-select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background-color: #f9fafb;
      font-size: 14px;
      min-width: 120px;
    }
    
    .filter-button {
      padding: 8px 16px;
      background-color: #15344a;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    
    .filter-button:hover {
      background-color: #1e4b6e;
    }
    
    #reset-filter {
      background-color: #6b7280;
    }
    
    #reset-filter:hover {
      background-color: #4b5563;
    }
  </style>
</head>
<body>
<div class="layout">
  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <img src="logo connecting.png" alt="Logo Connecting"/>
    </div>
    <div class="sidebar-title">Connecting</div>
    <div class="sidebar-nav">
      <button onclick="location.href='inicio.html'">Inicio</button>
      <button class="active" onclick="location.href='lead.html'">Lead</button>
      <button onclick="location.href='costumer.html'">Costumer</button>
      <button onclick="location.href='Facturacion.html'">Facturacion</button>
      <button onclick="logout()">Cerrar sesión</button>
    </div>
    <div class="sidebar-lema">
      "Conectando tu éxito, un cliente a la vez"
    </div>
  </nav>
  <main class="main-content">
    <div class="lead-content-row">
      <!-- FORMULARIO -->
      <section class="form-section" id="form-panel">
        <h2>Formulario de Registro</h2>
        <form id="crmForm">
          <div class="form-group">
            <label for="fecha-lead" style="color: #183153;">Fecha</label>
            <input type="date" id="fecha-lead" name="fecha-lead" />
          </div>
          <div class="form-group">
            <label for="team">Team</label>
            <select id="team" required>
              <option value="">Seleccione team</option>
              <option value="Team Irania">Team Irania</option>
              <option value="Team Pleitez">Team Pleitez</option>
              <option value="Team Roberto">Team Roberto</option>
              <option value="Team Lineas">Team Lineas</option>
              <option value="Team Randal">Team Randal</option>
              <option value="Team Marisol">Team Marisol</option>
            </select>
          </div>
          <div class="form-group">
            <label for="agent">Agente</label>
            <select id="agent" required>
              <option>Seleccione Agente</option>
            </select>
          </div>
          <div class="form-group">
            <label for="producto">Producto</label>
            <select id="producto" required>
              <option>Seleccione Producto</option>
            </select>
          </div>
          <div class="form-group">
            <label for="puntaje">Puntaje</label>
            <select id="puntaje" required>
              <option>Seleccione Puntaje</option>
              <option>Sin Puntaje</option>
              <option>0.25</option>
              <option>0.35</option>
              <option>1.0</option>
              <option>1.25</option>
              <option>1.50</option>
            </select>
          </div>
          <div class="form-group">
            <label for="cuenta">Cuenta Google</label>
            <select id="cuenta" required>
              <option>Seleccione Cuenta</option>
              <option>Cuenta Alexis</option>
              <option>Cuenta Eduardo</option>
              <option>Cuenta Israel</option>
              <option>Cuenta Lineas</option>
            </select>
          </div>
          <div class="form-group">
            <label for="telefono">Teléfono</label>
            <input type="text" id="telefono" placeholder="(XXX) XXX-XXXX" required/>
          </div>
          <div class="form-group">
            <label for="direccion">Dirección</label>
            <input type="text" id="direccion" placeholder="Dirección del cliente" required/>
          </div>
          <div class="form-group" style="margin-bottom: 26px;">
            <label for="zip">ZIP Code</label>
            <input type="text" id="zip" placeholder="Código ZIP" required/>
          </div>
          <button type="submit">Guardar Lead</button>
        </form>
      </section>

      <!-- SECCIÓN DE GRÁFICAS -->
      <section class="graphs-section">
        <!-- Filtro de Fecha -->
        <div class="date-filter-container">
          <div class="date-filter">
            <label for="month-select">Mes:</label>
            <select id="month-select" class="date-select">
              <option value="0">Enero</option>
              <option value="1">Febrero</option>
              <option value="2">Marzo</option>
              <option value="3">Abril</option>
              <option value="4">Mayo</option>
              <option value="5">Junio</option>
              <option value="6">Julio</option>
              <option value="7">Agosto</option>
              <option value="8">Septiembre</option>
              <option value="9">Octubre</option>
              <option value="10">Noviembre</option>
              <option value="11">Diciembre</option>
            </select>
            
            <label for="day-select">Día:</label>
            <select id="day-select" class="date-select">
              <!-- Los días se llenarán dinámicamente -->
            </select>
            
            <label for="year-select">Año:</label>
            <select id="year-select" class="date-select">
              <option value="2023">2023</option>
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
            
            <button id="apply-filter" class="filter-button">Aplicar Filtro</button>
            <button id="reset-filter" class="filter-button">Hoy</button>
          </div>
        </div>
        <!-- Gráfica combinada de Ventas y Puntaje -->
        <div class="graph-container">
          <h3>Ventas y Puntaje por Equipo</h3>
          <canvas id="ventasPuntajeChart" class="graph-canvas"></canvas>
        </div>
        
        <!-- Gráfica de Ventas por Producto -->
        <div class="graph-container">
          <h3>Ventas por Producto</h3>
          <canvas id="ventasProductoChart" class="graph-canvas"></canvas>
        </div>
      </section>
    </div>
  </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Variables globales para las gráficas
  let ventasPuntajeChart, ventasProductoChart;

  // Función para inicializar las gráficas
  function inicializarGraficas() {
    // Lista de productos proporcionada
    const listaProductos = [
      '225 AT&T AIR', '100 MBPS AT&T', '18 MBPS AT&T', '1G AT&T', '25 MBPS AT&T',
      '300 MBPS AT&T', '50 MBPS AT&T', '500 MBPS AT&T', '5G AT&T', '75 MBPS AT&T',
      'ALTAFIBER', 'FRONTIER', 'HUGHESNET', 'MAS LATINO', 'MAS ULTRA',
      'OPTIMO MAS', 'OPTIMUM', 'SPECTRUM', 'VIASAT', 'WINDSTREAM',
      'WOW', 'LINEA + CELULAR', 'VIVINT', 'KINETIC', 'SPECTRUM BUSINESS',
      'AT&T BUSINESS', 'DIRECTV BUSINESS', 'CONSOLIDATE COMMUNICATION', 'ZYPYLFIBER', 'SPECTRUM 500',
      'SPECTRUM 50', 'FRONTIER 200', 'FRONTIER 500', 'SPECTRUM 100', 'FRONTIER 100',
      'FRONTIER 1G', 'SPECTRUM 1G', 'FRONTIER 2G', 'SPECTRUM DOUBLE PLAY PREMIER', 'SPECTRUM DOUBLE PLAY ADVANTAGE',
      'FRONTIER 5G', 'EARTHLINK', 'BRIGHTSPEED', '2G AT&T', '2G SPECTRUM'
    ];

    // Datos de ejemplo - Estos serán reemplazados por datos reales del servidor
    const datosEjemplo = {
      ventasPuntaje: {
        labels: ['Team Irania', 'Team Pleitez', 'Team Roberto', 'Team Lineas', 'Team Randal', 'Team Marisol'],
        ventas: [12, 19, 3, 5, 2, 3],
        puntajes: [8.5, 12.25, 5.5, 7.0, 3.75, 9.0]
      },
      ventasProducto: {
        labels: listaProductos,
        // Generar datos aleatorios para cada producto (serán reemplazados por datos reales)
        datos: listaProductos.map(() => Math.floor(Math.random() * 50) + 1)
      }
    };

    // Configuración común para las gráficas
    const configComun = {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: 10
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            usePointStyle: true,
            pointStyle: 'circle',
            font: {
              size: 12
            }
          }
        },
        tooltip: {
          padding: 10,
          titleFont: {
            size: 13
          },
          bodyFont: {
            size: 12
          },
          boxPadding: 4
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.04)'
          },
          ticks: {
            padding: 8,
            font: {
              size: 11
            }
          },
          title: {
            display: true,
            font: {
              size: 12,
              weight: 'bold'
            },
            padding: { bottom: 10 }
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 11
            }
          }
        }
      },
      elements: {
        bar: {
          borderRadius: 6,
          borderSkipped: false,
        }
      }
    };

    // Gráfica combinada de Ventas y Puntaje
    const ctxVentasPuntaje = document.getElementById('ventasPuntajeChart').getContext('2d');
    ventasPuntajeChart = new Chart(ctxVentasPuntaje, {
      type: 'bar',
      data: {
        labels: datosEjemplo.ventasPuntaje.labels,
        datasets: [
          {
            label: 'Ventas',
            type: 'bar',
            data: datosEjemplo.ventasPuntaje.ventas,
            backgroundColor: 'rgba(34, 179, 236, 0.7)',
            borderColor: 'rgba(34, 179, 236, 1)',
            borderWidth: 1,
            borderRadius: 4,
            yAxisID: 'y'
          },
          {
            label: 'Puntaje',
            type: 'line',
            data: datosEjemplo.ventasPuntaje.puntajes,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
            pointBorderColor: '#fff',
            pointHoverRadius: 5,
            pointHoverBackgroundColor: 'rgba(255, 99, 132, 1)',
            pointHoverBorderColor: '#fff',
            pointHitRadius: 10,
            pointBorderWidth: 2,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        ...configComun,
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          ...configComun.plugins,
          title: {
            display: true,
            text: 'Ventas y Puntaje por Equipo'
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Ventas'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Puntaje'
            },
            grid: {
              drawOnChartArea: false
            }
          }
        }
      }
    });

    // Gráfica de Ventas por Producto
    const ctxVentasProducto = document.getElementById('ventasProductoChart').getContext('2d');
    ventasProductoChart = new Chart(ctxVentasProducto, {
      type: 'bar',
      data: {
        labels: datosEjemplo.ventasProducto.labels,
        datasets: [{
          label: 'Ventas',
          data: datosEjemplo.ventasProducto.datos,
          backgroundColor: 'rgba(37, 169, 221, 0.7)',
          borderColor: 'rgba(37, 169, 221, 1)',
          borderWidth: 1,
          barPercentage: 0.8,
          categoryPercentage: 0.9
        }]
      },
      options: {
        ...configComun,
        indexAxis: 'x', // Cambiado a 'x' para barras verticales
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          ...configComun.plugins,
          title: {
            display: true,
            text: 'Ventas por Producto',
            font: {
              size: 16,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          },
          legend: {
            display: false
          },
          tooltip: {
            ...configComun.plugins.tooltip,
            callbacks: {
              label: function(context) {
                return `Ventas: ${context.raw}`;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              autoSkip: true,
              maxRotation: 45,
              minRotation: 45,
              font: {
                size: 10
              },
              padding: 5
            },
            grid: {
              display: false
            },
            title: {
              display: true,
              text: 'Productos',
              font: {
                weight: 'bold'
              },
              padding: { top: 15 }
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Cantidad de Ventas',
              font: {
                weight: 'bold'
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              stepSize: 1,
              precision: 0
            }
          }
        },
        layout: {
          padding: {
            left: 10,
            right: 10,
            top: 10,
            bottom: 30
          }
        }
      }
    });

  }

  // Función para actualizar las gráficas con datos reales del servidor
  async function actualizarGraficas(fecha = null) {
    try {
      console.log("Actualizando gráficas..." + (fecha ? ` Filtro: ${fecha}` : ''));
      
      // Obtener datos del servidor con el filtro de fecha si se proporciona
      let url = '/api/productos';
      if (fecha) {
        url += `?fecha=${fecha}`;
      }
      
      // Hacer la petición al servidor
      const [responseVentas, responseProductos] = await Promise.all([
        fetch('/api/ventas' + (fecha ? `?fecha=${fecha}` : '')),
        fetch(url)
      ]);
      
      if (!responseVentas.ok || !responseProductos.ok) {
        throw new Error('Error al obtener los datos del servidor');
      }
      
      const ventasData = await responseVentas.json();
      const productosData = await responseProductos.json();
      
      // Procesar datos para las gráficas
      const datosReales = {
        ventasEquipo: {
          labels: ventasData.map(item => item.equipo || item.team || `Equipo ${item._id}`),
          ventas: ventasData.map(item => item.ventas || item.count || 0),
          puntajes: ventasData.map(item => item.puntaje || item.score || 0)
        },
        ventasProducto: {
          labels: productosData.map(item => item.producto || item._id || 'Sin nombre'),
          datos: productosData.map(item => item.ventas || item.count || 0)
        }
      };
      
      // Actualizar las gráficas con los datos reales
      actualizarGraficaVentasPuntaje(datosReales.ventasEquipo);
      actualizarGraficaVentasProducto(datosReales.ventasProducto);
      
      // Mostrar la fecha actual en el título de la página
      const tituloFecha = fecha ? new Date(fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' }) : 'hoy';
      document.title = `Connecting - ${tituloFecha}`;
      
    } catch (error) {
      console.error("Error al actualizar las gráficas:", error);
      // Mostrar mensaje de error al usuario
      alert("Error al cargar los datos. Por favor, intente de nuevo más tarde.");
    }
  }

  // SIDEBAR logout
  function logout() {
    fetch('/logout', { credentials: 'include' })
      .then(() => window.location.href = '/login.html');
  }

  // Función para obtener los días en un mes específico
  function getDaysInMonth(month, year) {
    // Nota: En JavaScript, los meses van de 0 a 11
    return new Date(year, month + 1, 0).getDate();
  }

  // Función para actualizar los días disponibles según el mes y año seleccionados
  function updateDaysDropdown() {
    const daySelect = document.getElementById('day-select');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    
    const selectedMonth = parseInt(monthSelect.value);
    const selectedYear = parseInt(yearSelect.value);
    const daysInMonth = getDaysInMonth(selectedMonth, selectedYear);
    
    // Guardar el día seleccionado actualmente
    const selectedDay = parseInt(daySelect.value) || 1;
    
    // Limpiar opciones actuales
    daySelect.innerHTML = '';
    
    // Agregar opciones de días
    for (let day = 1; day <= daysInMonth; day++) {
      const option = document.createElement('option');
      option.value = day;
      option.textContent = day;
      daySelect.appendChild(option);
    }
    
    // Establecer el día seleccionado (si es válido para el nuevo mes)
    if (selectedDay <= daysInMonth) {
      daySelect.value = selectedDay;
    } else {
      daySelect.value = daysInMonth; // Último día del mes si el día seleccionado es inválido
    }
  }
  
  // Función para establecer la fecha actual en los selectores
  function setCurrentDate() {
    const now = new Date();
    document.getElementById('month-select').value = now.getMonth();
    document.getElementById('year-select').value = now.getFullYear();
    updateDaysDropdown();
    document.getElementById('day-select').value = now.getDate();
  }
  
  // Función para obtener la fecha seleccionada en formato YYYY-MM-DD
  function getSelectedDate() {
    const day = document.getElementById('day-select').value.padStart(2, '0');
    const month = (parseInt(document.getElementById('month-select').value) + 1).toString().padStart(2, '0');
    const year = document.getElementById('year-select').value;
    return `${year}-${month}-${day}`;
  }
  
  // Función para cargar datos con filtro de fecha
  async function cargarDatosConFiltro() {
    const fechaSeleccionada = getSelectedDate();
    try {
      // Aquí iría la llamada a tu API para obtener los datos filtrados por fecha
      // Por ahora, usamos la función actualizarGraficas existente
      // En una implementación real, deberías modificar actualizarGraficas para aceptar una fecha
      console.log('Cargando datos para la fecha:', fechaSeleccionada);
      await actualizarGraficas(fechaSeleccionada);
    } catch (error) {
      console.error('Error al cargar datos con filtro:', error);
    }
  }

  // LÓGICA PRINCIPAL - Se ejecuta cuando el DOM está completamente cargado
  document.addEventListener("DOMContentLoaded", () => {
    // Inicializar los selectores de fecha
    setCurrentDate();
    
    // Agregar event listeners para actualizar los días cuando cambie el mes o el año
    document.getElementById('month-select').addEventListener('change', updateDaysDropdown);
    document.getElementById('year-select').addEventListener('change', updateDaysDropdown);
    
    // Event listener para el botón de aplicar filtro
    document.getElementById('apply-filter').addEventListener('click', cargarDatosConFiltro);
    
    // Event listener para el botón de restablecer a la fecha actual
    document.getElementById('reset-filter').addEventListener('click', () => {
      setCurrentDate();
      cargarDatosConFiltro();
    });
    
    // Inicializar las gráficas cuando el DOM esté listo
    inicializarGraficas();
    
    // Actualizar gráficas cada 5 minutos (300000 ms)
    setInterval(actualizarGraficas, 300000);
    // --- INICIALIZACIÓN DE ELEMENTOS ---
    const selects = {
      team: document.getElementById("team"),
      agent: document.getElementById("agent"),
      producto: document.getElementById("producto"),
      cuenta: document.getElementById("cuenta"),
      puntaje: document.getElementById("puntaje")
    };
    const crmForm = document.getElementById("crmForm");

    // --- DATOS PARA LOS SELECTS ---
    const data = {
      teams: {
        "Team Irania": ["Irania", "Michael", "Giselle"],
        "Team Pleitez": ["Pleitez", "Kevin", "Nelson"],
        "Team Roberto": ["Roberto", "Santos", "Erick"],
        "Team Lineas": ["Dania", "Genesis", "Ofelia"],
        "Team Randal": ["Randal", "Josue", "Elian"],
        "Team Marisol": ["Marisol", "Isabella", "Naidelyn"],
      },
      productos: [], // Se llenará dinámicamente con fetch
      cuentas: ["Nueva", "Winback", "Agregado"]
    };

    // --- LLENADO DE SELECTS DEL FORMULARIO ---
    async function llenarProductosDinamicamente() {
      try {
        // Usar la misma lista de productos que está definida en el backend
        const PRODUCTOS_FIJOS = [
          "ATT AIR",
          "FRONTIER 5 GIG",
          "INTERNET + TELEFONO + TV",
          "FRONTIER",
          "FRONTIER INTERNET SERVICIOS"
        ];
        
        // Actualizar el select de productos
        if (selects.producto) {
          selects.producto.innerHTML = '<option value="">Seleccione Producto</option>' + 
            PRODUCTOS_FIJOS.map(p => `<option value="${p}">${p}</option>`).join('');
          window.LISTA_PRODUCTOS = PRODUCTOS_FIJOS;
        }
      } catch (e) {
        console.error('Error al cargar productos:', e);
        if (selects.producto) {
          selects.producto.innerHTML = '<option value="">(Error cargando productos)</option>';
        }
        window.LISTA_PRODUCTOS = [];
      }
    }

    async function llenarSelects() {
      Object.keys(data.teams).forEach(team => selects.team.add(new Option(team, team)));
      data.cuentas.forEach(c => selects.cuenta.add(new Option(c, c)));
      await llenarProductosDinamicamente();
    }

    llenarSelects();

    selects.team.addEventListener("change", function () {
      selects.agent.innerHTML = '<option>Seleccione Agente</option>';
      if (this.value && data.teams[this.value]) {
        data.teams[this.value].forEach(agent => selects.agent.add(new Option(agent, agent)));
      }
    });

    document.getElementById('fecha-lead').value = new Date().toISOString().slice(0, 10);
    
    // --- LÓGICA DE FORMULARIO ---
    crmForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const form = e.target;
      const puntajeVal = form.puntaje.value;
      const body = {
        dia_venta: form['fecha-lead'].value,
        team: form.team.value,
        agent: form.agent.value,
        producto: form.producto.value,
        puntaje: puntajeVal === "Sin Puntaje" || puntajeVal === "Seleccione Puntaje" ? 0 : parseFloat(puntajeVal),
        cuenta: form.cuenta.value,
        telefono: form.telefono.value,
        direccion: form.direccion.value,
        zip: form.zip.value,
      };

      const token = localStorage.getItem('token');
      fetch("/api/leads", { 
        method: "POST", 
        headers: { 
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }, 
        body: JSON.stringify(body) 
      })
        .then(res => {
          if (!res.ok) throw new Error(`Error del servidor: ${res.status}`);
          return res.json();
        })
        .then(() => {
          alert("Lead guardado exitosamente.");
          crmForm.reset();
          document.getElementById('fecha-lead').value = new Date().toISOString().slice(0,10);
          actualizarGraficas();
        })
        .catch(error => {
          console.error("Error al guardar lead:", error);
          alert("Hubo un error al guardar el lead.");
        });
    });
  });
</script>
</body>
</html>