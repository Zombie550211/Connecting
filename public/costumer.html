<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Connecting - Costumer</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
    }
    body {
      min-height: 100vh;
      box-sizing: border-box;
    }
    nav {
      width: 220px;
      background: #1E2A38;
      color: white;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      height: 100vh;
      z-index: 10;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    }
    nav h2 {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin: 32px 0 24px 0;
      letter-spacing: 1px;
    }
    nav button {
      background: #2A3B4C;
      color: white;
      border: none;
      padding: 12px 24px;
      text-align: left;
      font-weight: 600;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
      margin: 4px 16px;
      font-size: 16px;
      outline: none;
    }
    nav button:hover,
    nav button.active {
      background: #00aaff;
      color: #fff;
    }
    .main-content {
      margin-left: 220px;
      min-height: 100vh;
      padding: 0;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: transparent;
      padding: 32px 40px 16px 40px;
      min-height: 80px;
    }
    header h1 {
      color: #003366;
      font-size: 2.1rem;
      margin: 0;
      letter-spacing: 1px;
      font-weight: 700;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1.1rem;
      padding: 18px 40px;
      background-color: #f2f2f2;
      border-radius: 2px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    .filters label {
      display: flex;
      align-items: center;
      font-weight: 500;
      font-size: 1rem;
      color: #222;
      gap: 6px;
    }
    .filters input,
    .filters select {
      padding: 7px 12px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: white;
      transition: border-color 0.2s, box-shadow 0.2s;
      min-width: 110px;
      margin-left: 4px;
    }
    .filters input:focus,
    .filters select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
    }
    .grafica-container {
      margin: 2rem 40px 2rem 40px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.03);
      padding: 1.5rem;
    }
    #mensajeSinDatos { color: red; font-weight: bold; }
    .table-wrapper {
      flex: 1;
      padding: 0 40px 0 40px;
      box-sizing: border-box;
      width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 3px 12px rgba(0,0,0,0.03);
    }
    th {
      background-color: #003366;
      color: white;
      padding: 0.75rem 0.5rem;
      text-align: left;
      font-weight: 700;
      letter-spacing: 0.5px;
      font-size: 1rem;
    }
    td {
      padding: 0.5rem 0.5rem;
      font-size: 0.97rem;
      font-weight: 400;
      border-bottom: 1px solid #ccc;
      background-color: white;
    }
    tbody tr:nth-child(odd) td {
      background-color: #ffffff;
    }
    tbody tr:nth-child(even) td {
      background-color: #f5f5f5;
    }
    .btn-eliminar {
      background-color: #add8e6;
      border: none;
      color: black;
      font-size: 16px;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 2px;
      transition: background 0.2s;
    }
    .btn-eliminar:hover {
      background-color: #87ceeb;
    }
    .btn-editar {
      background-color: #ffe066;
      border: none;
      color: #444;
      font-size: 16px;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 2px;
      transition: background 0.2s;
    }
    .btn-editar:hover {
      background-color: #ffd700;
    }
    @media (max-width: 900px) {
      nav {
        width: 54px;
        padding: 0;
      }
      .main-content {
        margin-left: 54px;
      }
      nav h2 {
        font-size: 0;
        margin: 24px 0 18px 0;
      }
      nav button {
        font-size: 0;
        padding: 18px 0;
        margin: 2px 6px;
      }
      .table-wrapper, .filters, header {
        padding-left: 10px;
        padding-right: 10px;
        margin-left: 0;
        margin-right: 0;
      }
    }
    @media (max-width: 700px) {
      .table-wrapper, .filters, header {
        padding-left: 5px;
        padding-right: 5px;
        margin-left: 0;
        margin-right: 0;
      }
      .main-content {
        margin-left: 0;
      }
      nav {
        position: static;
        width: 100%;
        height: auto;
        box-shadow: none;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
      nav button {
        width: 100%;
        min-width: 0;
        padding: 11px 8px;
        margin: 2px 2px;
      }
    }
    #modalEditar {
      display: none;
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: #0008;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    #modalEditar.active {
      display: flex;
    }
    #modalEditar .modal-content {
      background: white;
      border-radius: 8px;
      padding: 25px;
      min-width: 320px;
      box-shadow: 0 4px 20px #0002;
    }
    #modalEditar form input { margin-bottom: 10px; width: 100%; }
    #modalEditar form button { margin-right: 8px; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <nav>
    <h2>Connecting</h2>
    <button onclick="location.href='index.html'">Inicio</button>
    <button onclick="location.href='lead.html'">Lead</button>
    <button class="active">Costumer</button>
    <button onclick="location.href='#'">Reports</button>
  </nav>
  <!-- Contenido principal -->
  <div class="main-content">
    <header>
      <h1>Connecting</h1>
    </header>
    <!-- Formulario para agregar costumer -->
    <form id="costumerForm" style="margin:24px 40px;">
      <input placeholder="Team" id="team" required>
      <input placeholder="Agente" id="agent" required>
      <input placeholder="Producto" id="producto" required>
      <input placeholder="Puntaje" id="puntaje" type="number" step="0.01" required>
      <input placeholder="Cuenta" id="cuenta" required>
      <input placeholder="Teléfono" id="telefono" required>
      <input placeholder="Dirección" id="direccion" required>
      <input placeholder="ZIP" id="zip" required>
      <button type="submit">Agregar Costumer</button>
    </form>
    <div class="grafica-container">
      <h2>Ventas y Puntaje por Team</h2>
      <canvas id="graficaTeam"></canvas>
    </div>
    <div class="grafica-container">
      <h2>Ventas por Producto</h2>
      <canvas id="graficaProducto"></canvas>
      <div id="mensajeSinDatos"></div>
    </div>
    <div class="table-wrapper">
      <table id="tabla-costumer">
        <thead>
          <tr>
            <th>FECHA</th>
            <th>TEAM</th>
            <th>AGENTE</th>
            <th>TELÉFONO</th>
            <th>PRODUCTO</th>
            <th>PUNTAJE</th>
            <th>CUENTA</th>
            <th>DIRECCIÓN</th>
            <th>ZIP</th>
            <th>ACCIÓN</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- Modal de edición -->
    <div id="modalEditar">
      <div class="modal-content">
        <h3>Editar Costumer</h3>
        <form id="formEditarCostumer">
          <input id="editTeam" placeholder="Team" required>
          <input id="editAgent" placeholder="Agente" required>
          <input id="editProducto" placeholder="Producto" required>
          <input id="editPuntaje" type="number" step="0.01" placeholder="Puntaje" required>
          <input id="editCuenta" placeholder="Cuenta" required>
          <input id="editTelefono" placeholder="Teléfono" required>
          <input id="editDireccion" placeholder="Dirección" required>
          <input id="editZip" placeholder="ZIP" required>
          <input type="hidden" id="editId">
          <button type="submit">Guardar</button>
          <button type="button" onclick="cerrarModalEditar()">Cancelar</button>
        </form>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let costumers = [];
    let costumerEditandoId = null;
    let graficaTeam, graficaProducto;

    // Cargar costumers y graficas al iniciar
    window.onload = () => {
      cargarCostumers();
      iniciarGraficasCostumer();
      actualizarGraficasCostumer();
      setInterval(actualizarGraficasCostumer, 30000);
    };

    // 1. AGREGAR COSTUMER
    document.getElementById('costumerForm').onsubmit = async function(e) {
      e.preventDefault();
      const body = {
        team: document.getElementById('team').value,
        agent: document.getElementById('agent').value,
        producto: document.getElementById('producto').value,
        puntaje: parseFloat(document.getElementById('puntaje').value),
        cuenta: document.getElementById('cuenta').value,
        telefono: document.getElementById('telefono').value,
        direccion: document.getElementById('direccion').value,
        zip: document.getElementById('zip').value
      };
      const res = await fetch('/api/costumer', {
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(res.ok) {
        await cargarCostumers();
        actualizarGraficasCostumer();
        this.reset();
      } else {
        alert("Error al guardar costumer.");
      }
    };

    // 2. CARGAR Y MOSTRAR COSTUMERS
    async function cargarCostumers() {
      const res = await fetch('/api/costumer');
      const data = await res.json();
      costumers = data.costumers || [];
      renderizarTablaCostumer();
    }

    function renderizarTablaCostumer() {
      const tbody = document.querySelector('#tabla-costumer tbody');
      tbody.innerHTML = "";
      if (costumers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center">No hay datos</td></tr>';
        return;
      }
      costumers.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.fecha ? c.fecha.slice(0,10) : ''}</td>
          <td>${c.equipo || ''}</td>
          <td>${c.agente || ''}</td>
          <td>${c.telefono || ''}</td>
          <td>${c.producto || ''}</td>
          <td>${c.puntaje || ''}</td>
          <td>${c.cuenta || ''}</td>
          <td>${c.direccion || ''}</td>
          <td>${c.zip || ''}</td>
          <td>
            <button class="btn-editar" onclick="mostrarEditarCostumer('${c._id}')">✏️</button>
            <button class="btn-eliminar" onclick="eliminarCostumer('${c._id}')">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 3. ELIMINAR COSTUMER
    async function eliminarCostumer(id) {
      if (!confirm("¿Seguro que deseas eliminar este costumer?")) return;
      const res = await fetch(`/api/costumer/${id}`, { method: "DELETE" });
      if (res.ok) {
        await cargarCostumers();
        actualizarGraficasCostumer();
      } else {
        alert("No se pudo eliminar el costumer.");
      }
    }

    // 4. EDITAR COSTUMER
    function mostrarEditarCostumer(id) {
      const c = costumers.find(x => x._id === id);
      if (!c) return;
      costumerEditandoId = id;
      document.getElementById('editTeam').value = c.equipo || '';
      document.getElementById('editAgent').value = c.agente || '';
      document.getElementById('editProducto').value = c.producto || '';
      document.getElementById('editPuntaje').value = c.puntaje || '';
      document.getElementById('editCuenta').value = c.cuenta || '';
      document.getElementById('editTelefono').value = c.telefono || '';
      document.getElementById('editDireccion').value = c.direccion || '';
      document.getElementById('editZip').value = c.zip || '';
      document.getElementById('editId').value = c._id;
      document.getElementById('modalEditar').classList.add('active');
    }

    function cerrarModalEditar() {
      document.getElementById('modalEditar').classList.remove('active');
      costumerEditandoId = null;
    }

    document.getElementById('formEditarCostumer').onsubmit = async function(e) {
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const body = {
        equipo: document.getElementById('editTeam').value,
        agente: document.getElementById('editAgent').value,
        producto: document.getElementById('editProducto').value,
        puntaje: parseFloat(document.getElementById('editPuntaje').value),
        cuenta: document.getElementById('editCuenta').value,
        telefono: document.getElementById('editTelefono').value,
        direccion: document.getElementById('editDireccion').value,
        zip: document.getElementById('editZip').value
      };
      const res = await fetch(`/api/costumer/${id}`, {
        method: "PUT",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(res.ok) {
        cerrarModalEditar();
        await cargarCostumers();
        actualizarGraficasCostumer();
      } else {
        alert("No se pudo editar el costumer.");
      }
    };

    // 5. GRÁFICAS COSTUMER
    function iniciarGraficasCostumer() {
      const ctx1 = document.getElementById('graficaTeam').getContext('2d');
      graficaTeam = new Chart(ctx1, {
        type: 'bar',
        data: { labels: [], datasets: [
          { label: "Ventas por Equipo", data: [], backgroundColor:'#007bff', borderRadius:6 }
        ] },
        options: {
          plugins: {
            legend: { position: 'top' }
          }
        }
      });
      const ctx2 = document.getElementById('graficaProducto').getContext('2d');
      graficaProducto = new Chart(ctx2, {
        type: 'bar',
        data: { labels: [], datasets: [
          { label: "Ventas por Producto", data: [], backgroundColor:'#126de4e5', borderRadius:6 }
        ] },
        options: {
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    async function actualizarGraficasCostumer() {
      const res = await fetch('/api/graficas-costumer');
      const data = await res.json();

      // Equipo
      const labelsEquipo = Object.keys(data.ventasPorEquipo || {});
      const ventasEquipo = Object.values(data.ventasPorEquipo || {});
      graficaTeam.data.labels = labelsEquipo;
      graficaTeam.data.datasets[0].data = ventasEquipo;
      graficaTeam.update();
      // Producto
      const labelsProd = Object.keys(data.ventasPorProducto || {});
      const ventasProd = Object.values(data.ventasPorProducto || {});
      graficaProducto.data.labels = labelsProd;
      graficaProducto.data.datasets[0].data = ventasProd;
      graficaProducto.update();
      document.getElementById('mensajeSinDatos').style.display = ventasProd.some(v=>v>0) ? 'none' : '';
    }
  </script>
</body>
</html>