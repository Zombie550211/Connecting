<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM - Lead desde Costumer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f9f9f9; color: #333; }
    .container { display: flex; min-height: 100vh; }
    nav { width: 220px; background: #1E2A38; color: white; padding: 20px; display: flex; flex-direction: column; }
    nav h1 { margin: 0 0 20px; font-size: 1.5em; font-weight: 700; }
    nav button { background: #2A3B4C; color: white; border: none; padding: 10px; text-align: left; font-weight: 600; border-radius: 4px; cursor: pointer; margin-bottom: 10px; transition: background 0.3s;}
    nav button:hover { background: #00aaff; }
    main { flex: 1; padding: 30px; display: flex; gap: 30px; background: white; }
    .form-section { flex: 1; background: #fff; padding: 20px 25px; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 5px rgb(0 0 0 / 0.05);}
    .form-section h2 { margin-top: 0; margin-bottom: 15px; font-weight: 700; color: #222;}
    .form-group { margin-bottom: 15px;}
    label { display: block; font-weight: 600; margin-bottom: 6px;}
    select, input[type="text"], input[type="number"], button { width: 100%; padding: 8px 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px;}
    button { background-color: #126de4e5; border: none; color: white; font-weight: 700; cursor: pointer; transition: background-color 0.3s; }
    button:hover { background-color: #0056b3; }
    .charts-section { flex: 1; display: flex; flex-direction: column; gap: 20px; }
    .chart-container { background: #fff; padding: 15px 20px; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 5px rgb(0 0 0 / 0.05);}
    .chart-container h3 { margin-top: 0; font-weight: 700; margin-bottom: 10px;}
    .charts-filter { margin-bottom: 20px; padding: 10px 15px; background: #f3f7fa; border-radius: 6px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 14px;}
    .charts-filter label { font-weight: 600; margin-bottom: 0;}
    .charts-filter input[type="date"] { padding: 6px 10px; border-radius: 4px; border: 1px solid #b4c5d4;}
    .charts-filter button { width: auto; padding: 7px 20px; margin: 0; background: #126de4e5; border: none; color: white; border-radius: 4px; font-weight: 700; cursor: pointer; transition: background-color 0.3s;}
    .charts-filter button:hover { background: #0056b3; }
    .no-data-msg { color: #a00; font-weight: bold; text-align: center; margin-top: 10px;}
  </style>
</head>
<body>
<div class="container">
  <nav>
    <h1>Connecting</h1>
    <button onclick="location.href='#'">Inicio</button>
    <button onclick="location.href='lead.html'">Lead</button>
    <button onclick="location.href='costumer.html'">Costumer</button>
    <button onclick="location.href='#'">Reports</button>
  </nav>
  <main>
    <section class="form-section">
      <h2>Formulario de Registro</h2>
      <form id="crmForm">
        <div class="form-group">
          <label for="team">Team</label>
          <select id="team">
            <option value="">Seleccione team</option>
            <option value="Team Irania">Team Irania</option>
            <option value="Team Pleitez">Team Pleitez</option>
            <option value="Team Roberto">Team Roberto</option>
            <option value="Team Lineas">Team Lineas</option>
            <option value="Team Randal">Team Randal</option>
            <option value="Team Marisol">Team Marisol</option>
          </select>
        </div>
        <div class="form-group">
          <label for="agent">Agente</label>
          <select id="agent">
            <option>Seleccione Agente</option>
          </select>
        </div>
        <div class="form-group">
          <label for="producto">Producto</label>
          <select id="producto">
            <option>Seleccione Producto</option>
          </select>
        </div>
        <div class="form-group">
          <label for="puntaje">Puntaje</label>
          <select id="puntaje">
            <option>Seleccione Puntaje</option>
            <option>Sin Puntaje</option>
            <option>0.25</option>
            <option>0.35</option>
            <option>1.0</option>
            <option>1.25</option>
            <option>1.50</option>
          </select>
        </div>
        <div class="form-group">
          <label for="cuenta">Cuenta</label>
          <select id="cuenta">
            <option>Seleccione Cuenta</option>
            <option>Cuenta Alexis</option>
            <option>Cuenta Eduardo</option>
            <option>Cuenta Israel</option>
            <option>Cuenta Lineas</option>
          </select>
        </div>
        <div class="form-group">
          <label for="telefono">Agregue número de teléfono</label>
          <input type="text" id="telefono" placeholder="(XXX) XXX-XXXX" />
        </div>
        <div class="form-group">
          <label for="direccion">Dirección</label>
          <input type="text" id="direccion" placeholder="Dirección del cliente" />
        </div>
        <div class="form-group">
          <label for="zip">ZIP Code</label>
          <input type="text" id="zip" placeholder="Código ZIP" />
        </div>
        <button type="submit">Guardar Lead</button>
      </form>
      <!-- Botones de importar, actualizar y descargar ELIMINADOS -->
    </section>
    <section class="charts-section">
      <div class="charts-filter">
        <label for="fechaGraficas">Filtrar gráficas por fecha:</label>
        <input type="date" id="fechaGraficas" />
        <button type="button" onclick="actualizarGraficas()">Ver gráficas</button>
      </div>
      <div class="chart-container">
        <h3>Ventas y Puntaje por Team</h3>
        <canvas id="ventasTeamChart"></canvas>
        <div id="no-data-team" class="no-data-msg" style="display:none">No hay datos para esta fecha</div>
      </div>
      <div class="chart-container">
        <h3>Ventas por Producto</h3>
        <canvas id="productosChart"></canvas>
        <div id="no-data-producto" class="no-data-msg" style="display:none">No hay datos para esta fecha</div>
      </div>
    </section>
  </main>
</div>

<script>
const equipos = ["Team Irania", "Team Pleitez", "Team Roberto", "Team Lineas", "Team Randal", "Team Marisol"];
const productos = [
  "225 AT&T AIR", "18 AT&T", "25 AT&T", "50 AT&T", "75 AT&T", "100 AT&T", "300 AT&T", "500 AT&T", "1G AT&T", "5G AT&T",
  "2GB SPECTRUM", "1GB SPECTRUM", "500 SPECTRUM", "200 SPECTRUM", "SPECTRUM BUSSINES", "SPECTRUM PREMIER", "SPECTRUM ADVENTAGE",
  "5GB FRONTIER", "2GB FRONTIER", "1GB FRONTIER", "500 FRONTIER", "200 FRONTIER",
  "OPTIMO MAS", "MAS LATINO", "MAS ULTRA", "DIRECTV BUSSINES", "HUGHESNET", "OPTIMUM", "VIASAT", "WINDSTREAM",
  "VIVINT", "KINETICK", "WOW", "ALTAFIBER", "ZYPLYFIBER", "CONSOLIDATE COMUNICATION", "BRIGHTSPEED", "EARTHLINK", "LINEA + CELULAR"
];

const agentesPorTeam = {
  "Team Irania": ["Irvin Cruz", "Josue Renderos", "Julissa Rubio", "Miguel Nunez", "Pamela Urrutia", "Roxana Martinez", "Estefany Amaya","Giselle Diaz"],
  "Team Pleitez": ["Diego Mejia", "Fabricio Panameño", "Luis Chavarria", "Mauricio Rivera", "Steven Varela", "Estefany Garcia", "Ellen Diaz"],
  "Team Roberto": ["Carlos Marroquin", "Daniela Bonilla", "Francisco Aguilar", "Ingrid Garcia", "Lisbeth Cortez", "Nelson Ceren", "Tatiana Ayala"],
  "Team Lineas": ["Jocelyn R Lineas", "Jonathan Figueroa", "Lineas-Carlos", "Lineas-Cristian R", "Lineas-Diego.O", "Lineas-Edward", "Lineas-Kenia", "Lineas-Luis G", "Lineas-Oscar R", "Lineas-Ricardo"],
  "Team Randal": ["Abigail Morales", "Alexander Montecinos", "Anderson Guzman", "Carlos Grande", "Johana Santana", "Julio Chavez",  "Priscila Hernandez", "Randal Martinez"],
  "Team Marisol": ["Alessandro Romero", "Fernanda Castillo", "Katerine Gomez", "Kimberly Iglesias", "Marisol Beltran", "Paola Trejo", "Rodrigo Hernandez", "Tatiana Valdez"]
};

document.getElementById("team").addEventListener("change", function () {
  const team = this.value;
  const selectAgente = document.getElementById("agent");
  selectAgente.innerHTML = "<option>Seleccione Agente</option>";
  if (agentesPorTeam[team]) {
    agentesPorTeam[team].forEach(agente => {
      const option = document.createElement("option");
      option.value = agente;
      option.textContent = agente;
      selectAgente.appendChild(option);
    });
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const selectProducto = document.getElementById("producto");
  productos.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    selectProducto.appendChild(opt);
  });
  iniciarGraficas();

  // Selecciona la fecha de hoy por defecto al cargar la página
  const hoy = new Date().toISOString().slice(0,10);
  document.getElementById('fechaGraficas').value = hoy;

  // Cargar las gráficas de la fecha seleccionada
  actualizarGraficas();

  // Opcional: auto-actualización cada 30 segundos con la fecha seleccionada
  setInterval(actualizarGraficas, 30000);
});

let ventasTeamChart, productosChart;

function iniciarGraficas() {
  const ctxTeam = document.getElementById("ventasTeamChart").getContext("2d");
  ventasTeamChart = new Chart(ctxTeam, {
    type: 'bar',
    data: {
      labels: equipos,
      datasets: [
        {
          label: 'Ventas',
          data: equipos.map(() => 0),
          backgroundColor: '#007bff',
          borderRadius: 6
        },
        {
          label: 'Puntaje',
          data: equipos.map(() => 0),
          backgroundColor: '#dc3545',
          borderRadius: 6
        }
      ]
    },
    options: {
      animation: true,
      responsive: true,
      plugins: {
        datalabels: {
          display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
          color: '#000',
          anchor: 'end',
          align: 'top',
          font: { weight: 'bold' },
          formatter: value => value
        },
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true, ticks: { display: false }, grid: { display: false } },
        x: { grid: { display: false } }
      }
    },
    plugins: [ChartDataLabels]
  });

  const ctxProducto = document.getElementById("productosChart").getContext("2d");
  productosChart = new Chart(ctxProducto, {
    type: 'bar',
    data: {
      labels: productos,
      datasets: [{
        label: 'Ventas por Producto',
        data: productos.map(() => 0),
        backgroundColor: '#007bff',
        borderRadius: 6
      }]
    },
    options: {
      animation: true,
      responsive: true,
      plugins: {
        datalabels: {
          display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
          color: '#000',
          anchor: 'end',
          align: 'top',
          font: { weight: 'bold' },
          formatter: value => value
        },
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true, ticks: { display: false }, grid: { display: false } },
        x: { grid: { display: false } }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// AHORA USA EL ENDPOINT DE MONGODB
function actualizarGraficas() {
  const fecha = document.getElementById('fechaGraficas').value;
  fetch(`/api/graficas?fecha=${fecha}`)
    .then(res => res.json())
    .then(data => {
      if (!data || typeof data !== 'object') {
        mostrarNoData(true, true);
        return;
      }

      // Ventas y puntaje por equipo
      let hayDataTeam = false;
      equipos.forEach((team, i) => {
        const ventas = data.ventasPorEquipo && data.ventasPorEquipo[team] ? data.ventasPorEquipo[team] : 0;
        const puntos = data.puntosPorEquipo && data.puntosPorEquipo[team] ? data.puntosPorEquipo[team] : 0;
        ventasTeamChart.data.datasets[0].data[i] = ventas;
        ventasTeamChart.data.datasets[1].data[i] = team === "Team Lineas" ? 0 : puntos;
        if (ventas > 0 || puntos > 0) hayDataTeam = true;
      });
      ventasTeamChart.update();
      mostrarNoData(!hayDataTeam, false);

      // Ventas por producto
      let hayDataProd = false;
      productos.forEach((prod, i) => {
        const ventas = data.ventasPorProducto && data.ventasPorProducto[prod] ? data.ventasPorProducto[prod] : 0;
        productosChart.data.datasets[0].data[i] = ventas;
        if (ventas > 0) hayDataProd = true;
      });
      productosChart.update();
      mostrarNoData(false, !hayDataProd);
    })
    .catch(err => {
      console.error("Error al cargar gráficas:", err);
      mostrarNoData(true, true);
    });
}

function mostrarNoData(team, producto) {
  document.getElementById('no-data-team').style.display = team ? '' : 'none';
  document.getElementById('no-data-producto').style.display = producto ? '' : 'none';
}

document.getElementById("crmForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const team = document.getElementById("team").value;
  const agent = document.getElementById("agent").value;
  const producto = document.getElementById("producto").value;
  const puntajeVal = document.getElementById("puntaje").value;
  const puntaje = puntajeVal === "Sin Puntaje" || puntajeVal === "Seleccione Puntaje" ? 0 : parseFloat(puntajeVal);
  const cuenta = document.getElementById("cuenta").value;
  const telefono = document.getElementById("telefono").value;
  const direccion = document.getElementById("direccion").value;
  const zip = document.getElementById("zip").value;

  if (
    team === "" || agent === "Seleccione Agente" ||
    producto === "Seleccione Producto" || isNaN(puntaje) ||
    cuenta === "Seleccione Cuenta" || telefono.trim() === "" ||
    direccion.trim() === "" || zip.trim() === ""
  ) {
    alert("Por favor, complete todos los campos.");
    return;
  }

  fetch("/api/leads", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ team, agent, producto, puntaje, cuenta, telefono, direccion, zip })
  })
    .then(async res => {
      if (!res.ok) {
        const errorText = await res.text();
        console.error("Error en respuesta:", res.status, errorText);
        throw new Error("Error al guardar el lead.");
      }
      return res.json();
    })
    .then(() => {
      actualizarGraficas();
      document.getElementById("crmForm").reset();
      alert("Lead guardado exitosamente.");
    })
    .catch(error => {
      console.error("Error al guardar lead:", error);
      alert("Hubo un error al guardar el lead. Revisa la consola.");
    });
});
</script>
</body>
</html>