<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM - Lead desde Costumer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f9f9f9; color: #333; }
    .container { display: flex; min-height: 100vh; }
    nav {
      width: 220px;
      background: #000000ea;
      color: rgb(245, 245, 245);
      padding: 28px 16px 28px 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    nav h1 {
      margin: 0 0 20px;
      font-size: 2em;
      font-weight: 700;
    }
    nav button {
      width: 100%;
      background: #000000ea;
      color: rgb(255, 255, 255);
      border: none;
      padding: 20px;
      margin-bottom: 12px;
      text-align: center;
      font-weight: 675;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.2em;
      transition: background 0.2s, color 0.2s;
    }
    nav button:hover,
    nav button.active {
      background: #8cdeff;
      color: #fff;
    }
    nav button.active {
      background: #8cdeff;
      color: #fff;
    }
    /* Import Excel form style */
    .import-lead-form {
      margin-bottom:18px;
      width:100%;
    }
    .import-lead-form .import-lead-row {
      display:flex;
      gap:8px;
      align-items:center;
    }
    .import-lead-form label {
      background:#42a5f5;
      color:#fff;
      border-radius:4px;
      padding:7px 18px;
      font-weight:600;
      cursor:pointer;
      margin-bottom:0 !important;
      font-size:1em;
    }
    .import-lead-form input[type="file"] {
      display:none;
    }
    .import-lead-form .file-name {
      color:#1976d2;
      font-size:0.98em;
      max-width:110px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .import-lead-form button[type="submit"] {
      background:#42a5f5;
      color:#fff;
      padding:7px 16px;
      border:none;
      border-radius:4px;
      font-weight:600;
      cursor:pointer;
      font-size:1em;
      transition: background 0.2s;
    }
    .import-lead-form button[type="submit"]:hover {
      background:#1e88e5;
    }
    .import-lead-form #import-status-lead {
      font-size:0.95em;
      margin-top:5px;
      min-height:18px;
    }
    main { flex: 1; padding: 30px; display: flex; gap: 10px; background: rgb(255, 255, 255); }
    .form-section { flex: 1; background: #fff; padding: 30px 25px; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 5px rgb(0 0 0 / 0.05);}
    .form-section h2 { margin-top: 0; margin-bottom: 15px; font-weight: 700; color: #141414;}
    .form-group { margin-bottom: 8px;}
    label:not(.import-lead-label) { display: block; font-weight: 600; margin-bottom: 6px;}
    select, input[type="text"], input[type="number"], input[type="date"], button { width: 100%; padding: 8px 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px;}
    button[type="submit"] { background-color: #126de4e5; border: none; color: white; font-weight: 700; cursor: pointer; transition: background-color 0.3s; }
    button[type="submit"]:hover { background-color: #0056b3; }
    .charts-section { flex: 1; display: flex; flex-direction: column; gap: 20px; }
    .chart-container { background: #fff; padding: 15px 20px; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 5px rgb(0 0 0 / 0.05);}
    .chart-container h3 { margin-top: 0; font-weight: 700; margin-bottom: 10px;}
    .charts-filter { margin-bottom: 20px; padding: 10px 15px; background: #f3f7fa; border-radius: 6px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 14px;}
    .charts-filter label { font-weight: 50; margin-bottom: 0;}
    .charts-filter input[type="date"] { padding: 6px 10px; border-radius: 4px; border: 1px solid #b4c5d4;}
    .charts-filter button { width: auto; padding: 7px 20px; margin: 0; background: #126de4e5; border: none; color: white; border-radius: 4px; font-weight: 700; cursor: pointer; transition: background-color 0.3s;}
    .charts-filter button:hover { background: #0b0f11; }
    .no-data-msg { color: #a00; font-weight: bold; text-align: center; margin-top: 10px;}
    @media (max-width: 900px) {
      .container { flex-direction: column;}
      main { flex-direction: column; }
      nav { width: 100%; flex-direction: row; align-items: flex-start; padding: 16px 6px;}
      nav h1 { font-size:1.3em; margin-bottom:0; }
      nav button, .import-lead-form { width:auto; padding: 10px 8px; margin-bottom:0; font-size:1em;}
      .import-lead-form { margin-bottom:0; }
      .import-lead-form .import-lead-row { flex-direction:column; align-items:flex-start; gap:4px;}
    }
  </style>
</head>
<body>
<div class="container">
  <nav>
    <h1>Connecting</h1>
    <button onclick="location.href='#'">Inicio</button>
    <button onclick="location.href='lead.html'" class="active">Lead</button>
    <button onclick="location.href='costumer.html'">Costumer</button>
    <button onclick="location.href='#'">Reports</button>
    <button onclick="logout()">Cerrar sesión</button>

    <!-- Importar Excel para Leads -->
    <form id="form-importar-excel-lead" class="import-lead-form" enctype="multipart/form-data">
      <div class="import-lead-row">
        <label class="import-lead-label">
          Seleccionar archivo
          <input type="file" name="archivo" id="input-excel-lead" accept=".xlsx,.xls">
        </label>
        <span id="file-name-lead" class="file-name">Ningún archivo seleccionado</span>
        <button type="submit">Importar Excel</button>
      </div>
      <div id="import-status-lead"></div>
    </form>
  </nav>
  <main>
    <section class="form-section">
      <h2>Formulario de Registro</h2>
      <form id="crmForm">
        <div class="form-group">
          <label for="fecha-lead">Fecha</label>
          <input type="date" id="fecha-lead" name="fecha-lead" />
        </div>
        <div class="form-group">
          <label for="team">Team</label>
          <select id="team" required>
            <option value="">Seleccione team</option>
            <option value="Team Irania">Team Irania</option>
            <option value="Team Pleitez">Team Pleitez</option>
            <option value="Team Roberto">Team Roberto</option>
            <option value="Team Lineas">Team Lineas</option>
            <option value="Team Randal">Team Randal</option>
            <option value="Team Marisol">Team Marisol</option>
          </select>
        </div>
        <div class="form-group">
          <label for="agent">Agente</label>
          <select id="agent" required>
            <option>Seleccione Agente</option>
          </select>
        </div>
        <div class="form-group">
          <label for="producto">Producto</label>
          <select id="producto" required>
            <option>Seleccione Producto</option>
          </select>
        </div>
        <div class="form-group">
          <label for="puntaje">Puntaje</label>
          <select id="puntaje" required>
            <option>Seleccione Puntaje</option>
            <option>Sin Puntaje</option>
            <option>0.25</option>
            <option>0.35</option>
            <option>1.0</option>
            <option>1.25</option>
            <option>1.50</option>
          </select>
        </div>
        <div class="form-group">
          <label for="cuenta">Cuenta Google</label>
          <select id="cuenta" required>
            <option>Seleccione Cuenta</option>
            <option>Cuenta Alexis</option>
            <option>Cuenta Eduardo</option>
            <option>Cuenta Israel</option>
            <option>Cuenta Lineas</option>
          </select>
        </div>
        <div class="form-group">
          <label for="telefono">Teléfono</label>
          <input type="text" id="telefono" placeholder="(XXX) XXX-XXXX" required/>
        </div>
        <div class="form-group">
          <label for="direccion">Dirección</label>
          <input type="text" id="direccion" placeholder="Dirección del cliente" required/>
        </div>
        <div class="form-group">
          <label for="zip">ZIP Code</label>
          <input type="text" id="zip" placeholder="Código ZIP" required/>
        </div>
        <button type="submit">Guardar Lead</button>
      </form>
    </section>
    <section class="charts-section">
      <div class="charts-filter">
        <label for="fechaGraficas">Filtrar gráficas por fecha:</label>
        <input type="date" id="fechaGraficas" />
        <button type="button" onclick="actualizarGraficas()">Ver gráficas</button>
      </div>
      <div class="chart-container">
        <canvas id="ventasTeamChart"></canvas>
        <div id="no-data-team" class="no-data-msg" style="display:none">No hay datos para esta fecha</div>
      </div>
      <div class="chart-container">
        <canvas id="productosChart"></canvas>
        <div id="no-data-producto" class="no-data-msg" style="display:none">No hay datos para esta fecha</div>
      </div>
    </section>
  </main>
</div>

<script>
const equipos = ["Team Irania", "Team Pleitez", "Team Roberto", "Team Lineas", "Team Randal", "Team Marisol"];
const productos = [
  "225 AT&T AIR", "18 AT&T", "25 AT&T", "50 AT&T", "75 AT&T", "100 AT&T", "300 AT&T", "500 AT&T", "1G AT&T", "5G AT&T",
  "2GB SPECTRUM", "1GB SPECTRUM", "500 SPECTRUM", "200 SPECTRUM", "SPECTRUM BUSSINES", "SPECTRUM PREMIER", "SPECTRUM ADVENTAGE",
  "5GB FRONTIER", "2GB FRONTIER", "1GB FRONTIER", "500 FRONTIER", "200 FRONTIER",
  "OPTIMO MAS", "MAS LATINO", "MAS ULTRA", "DIRECTV BUSSINES", "HUGHESNET", "OPTIMUM", "VIASAT", "WINDSTREAM",
  "VIVINT", "KINETICK", "WOW", "ALTAFIBER", "ZYPLYFIBER", "CONSOLIDATE COMUNICATION", "BRIGHTSPEED", "EARTHLINK", "LINEA + CELULAR"
];

const agentesPorTeam = {
  "Team Irania": ["Irvin Cruz", "Josue Renderos", "Julissa Rubio", "Miguel Nunez", "Pamela Urrutia", "Roxana Martinez", "Estefany Amaya","Giselle Diaz"],
  "Team Pleitez": ["Diego Mejia", "Fabricio Panameño", "Luis Chavarria", "Mauricio Rivera", "Steven Varela", "Estefany Garcia", "Andy Lopez","Cristopher Urrutia", "Abigail Galdamez"],
  "Team Roberto": ["Lucia Ferman","Daniela Bonilla", "Francisco Aguilar", "Ingrid Garcia", "Lisbeth Cortez", "Nelson Ceren", "Tatiana Ayala","David Quinteros"],
  "Team Lineas": ["Jocelyn R Lineas", "Jonathan Figueroa", "Lineas-Carlos", "Lineas-Cristian R", "Lineas-Diego.O", "Lineas-Edward","Lineas-Luis G", "Lineas-Oscar R", "Lineas-Ricardo"],
  "Team Randal": ["Anderson Guzman", "Carlos Grande", "Johana Santana", "Julio Chavez",  "Priscila Hernandez", "Randal Martinez"],
  "Team Marisol": ["Fernanda Castillo", "Katerine Gomez", "Kimberly Iglesias", "Marisol Beltran"],
};

document.getElementById("team").addEventListener("change", function () {
  const team = this.value;
  const selectAgente = document.getElementById("agent");
  selectAgente.innerHTML = "<option>Seleccione Agente</option>";
  if (agentesPorTeam[team]) {
    agentesPorTeam[team].forEach(agente => {
      const option = document.createElement("option");
      option.value = agente;
      option.textContent = agente;
      selectAgente.appendChild(option);
    });
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const selectProducto = document.getElementById("producto");
  productos.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    selectProducto.appendChild(opt);
  });

  // Selecciona la fecha de hoy por defecto al cargar la página
  const hoy = new Date().toISOString().slice(0,10);
  document.getElementById('fechaGraficas').value = hoy;
  // NUEVO: selecciona la fecha de hoy por defecto en el formulario
  document.getElementById('fecha-lead').value = hoy;

  iniciarGraficas();
  actualizarGraficas();

  // Opcional: auto-actualización cada 30 segundos con la fecha seleccionada
  setInterval(actualizarGraficas, 30000);
});

let ventasTeamChart, productosChart;

function iniciarGraficas() {
  const ctxTeam = document.getElementById("ventasTeamChart").getContext("2d");
  ventasTeamChart = new Chart(ctxTeam, {
    type: 'bar',
    data: {
      labels: equipos,
      datasets: [
        {
          label: 'Ventas',
          data: equipos.map(() => 0),
          backgroundColor: '#007bff',
          borderRadius: 6
        },
        {
          label: 'Puntaje',
          data: equipos.map(() => 0),
          backgroundColor: '#dc3545',
          borderRadius: 6
        }
      ]
    },
    options: {
      animation: true,
      responsive: true,
      plugins: {
        datalabels: {
          display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
          color: '#000',
          anchor: 'end',
          align: 'top',
          font: { weight: 'bold' },
          formatter: value => value
        },
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true, ticks: { display: false }, grid: { display: false } },
        x: { grid: { display: false } }
      }
    },
    plugins: [ChartDataLabels]
  });

  const ctxProducto = document.getElementById("productosChart").getContext("2d");
  productosChart = new Chart(ctxProducto, {
    type: 'bar',
    data: {
      labels: productos,
      datasets: [{
        label: 'Ventas por Producto',
        data: productos.map(() => 0),
        backgroundColor: '#007bff',
        borderRadius: 6
      }]
    },
    options: {
      animation: true,
      responsive: true,
      plugins: {
        datalabels: {
          display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
          color: '#000',
          anchor: 'end',
          align: 'start', // Cambiado para que siempre se muestre arriba de la barra
          offset: -8,     // Eleva el número encima de la barra
          font: { weight: 'bold' },
          formatter: value => value
        },
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true, ticks: { display: false }, grid: { display: false } },
        x: { grid: { display: false } }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function actualizarGraficas() {
  const fecha = document.getElementById('fechaGraficas').value;
  fetch(`/api/graficas?fecha=${fecha}`, {
    credentials: 'include'
  })
    .then(res => {
      if (res.status === 401) {
        alert("Tu sesión ha expirado. Inicia sesión nuevamente.");
        window.location.href = "/login.html";
        throw new Error("No autorizado. Verifica tu sesión.");
      }
      if (res.status === 500) {
        mostrarNoData(true, true);
        throw new Error("Error interno del servidor (500).");
      }
      return res.json();
    })
    .then(data => {
      if (!data || typeof data !== 'object') {
        mostrarNoData(true, true);
        return;
      }

      // Ventas y puntaje por equipo
      let hayDataTeam = false;
      equipos.forEach((team, i) => {
        const ventas = data.ventasPorEquipo && data.ventasPorEquipo[team] ? data.ventasPorEquipo[team] : 0;
        const puntos = data.puntosPorEquipo && data.puntosPorEquipo[team] ? data.puntosPorEquipo[team] : 0;
        ventasTeamChart.data.datasets[0].data[i] = ventas;
        ventasTeamChart.data.datasets[1].data[i] = team === "Team Lineas" ? 0 : puntos;
        if (ventas > 0 || puntos > 0) hayDataTeam = true;
      });
      ventasTeamChart.update();
      mostrarNoData(!hayDataTeam, false);

      // Ventas por producto
      let hayDataProd = false;
      productos.forEach((prod, i) => {
        const ventas = data.ventasPorProducto && data.ventasPorProducto[prod] ? data.ventasPorProducto[prod] : 0;
        productosChart.data.datasets[0].data[i] = ventas;
        if (ventas > 0) hayDataProd = true;
      });
      productosChart.update();
      mostrarNoData(false, !hayDataProd);
    })
    .catch(err => {
      console.error("Error al cargar gráficas:", err);
      mostrarNoData(true, true);
    });
}

function mostrarNoData(team, producto) {
  document.getElementById('no-data-team').style.display = team ? '' : 'none';
  document.getElementById('no-data-producto').style.display = producto ? '' : 'none';
}

document.getElementById("crmForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const fecha = document.getElementById("fecha-lead").value;
  const team = document.getElementById("team").value;
  const agent = document.getElementById("agent").value;
  const producto = document.getElementById("producto").value;
  const puntajeVal = document.getElementById("puntaje").value;
  const puntaje = puntajeVal === "Sin Puntaje" || puntajeVal === "Seleccione Puntaje" ? 0 : parseFloat(puntajeVal);
  const cuenta = document.getElementById("cuenta").value;
  const telefono = document.getElementById("telefono").value;
  const direccion = document.getElementById("direccion").value;
  const zip = document.getElementById("zip").value;

  if (
    team === "" || agent === "Seleccione Agente" ||
    producto === "Seleccione Producto" || isNaN(puntaje) ||
    cuenta === "Seleccione Cuenta" || telefono.trim() === "" ||
    direccion.trim() === "" || zip.trim() === ""
  ) {
    alert("Por favor, complete todos los campos.");
    return;
  }

  fetch("/api/leads", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: 'include',
    body: JSON.stringify({ fecha, team, agent, producto, puntaje, cuenta, telefono, direccion, zip })
  })
    .then(async res => {
      if (res.status === 401) {
        alert("Tu sesión ha expirado. Inicia sesión nuevamente.");
        window.location.href = "/login.html";
        throw new Error("No autorizado.");
      }
      // Si la respuesta NO es JSON, no la intentes parsear como JSON.
      const contentType = res.headers.get('content-type') || '';
      if (!res.ok) {
        if (contentType.includes('application/json')) {
          const errorText = await res.text();
          console.error("Error en respuesta:", res.status, errorText);
        } else {
          console.error("Respuesta inesperada:", res.status, await res.text());
        }
        throw new Error("Error al guardar el lead.");
      }
      if (contentType.includes('application/json')) {
        return res.json();
      } else {
        throw new Error("Respuesta inesperada del servidor.");
      }
    })
    .then(() => {
      actualizarGraficas();
      document.getElementById("crmForm").reset();
      // Restaurar la fecha de hoy después de resetear el formulario
      document.getElementById('fecha-lead').value = new Date().toISOString().slice(0,10);
      alert("Lead guardado exitosamente.");
    })
    .catch(error => {
      console.error("Error al guardar lead:", error);
      alert("Hubo un error al guardar el lead. Revisa la consola.");
    });
});

// --- Importar Leads desde Excel ---
const inputExcelLead = document.getElementById('input-excel-lead');
const fileNameLead = document.getElementById('file-name-lead');
inputExcelLead.addEventListener('change', function() {
  fileNameLead.textContent = this.files && this.files.length ? this.files[0].name : "Ningún archivo seleccionado";
});
document.getElementById('form-importar-excel-lead').onsubmit = async function(e) {
  e.preventDefault();
  const statusDiv = document.getElementById('import-status-lead');
  statusDiv.textContent = '';
  statusDiv.style.color = "";
  const formData = new FormData(this);
  try {
    const resp = await fetch('/api/leads/import', {
      method: 'POST',
      body: formData,
      credentials: 'include'
    });
    const resJson = await resp.json();
    if (resp.ok && resJson.success) {
      statusDiv.textContent = `Importación exitosa: ${resJson.count || 0} registros agregados.`;
      statusDiv.style.color = "green";
      actualizarGraficas();
    } else {
      statusDiv.textContent = "Error al importar: " + (resJson.error || "Error desconocido");
      statusDiv.style.color = "red";
    }
  } catch (err) {
    statusDiv.textContent = "Error de red al importar: " + err.message;
    statusDiv.style.color = "red";
  }
  this.reset();
  fileNameLead.textContent = "Ningún archivo seleccionado";
};

// Función para logout seguro
function logout() {
  fetch('/logout', { credentials: 'include' })
    .then(() => window.location.href = '/login.html');
}
</script>
</body>
</html>